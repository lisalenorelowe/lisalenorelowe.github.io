<HTML> <BODY BGCOLOR=#eeeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!-------------------------------------------<a name='2'></font>
<font color=#447700>!PI: John C. Lehrter, Ph.D.<a name='3'></font>
<font color=#447700>!USEPA/NHEERL Gulf Ecology Division<a name='4'></font>
<font color=#447700>!1 Sabine Island Drive<a name='5'></font>
<font color=#447700>!Gulf Breeze, FL 32561-5299<a name='6'></font>
<font color=#447700>!(850) 934-9255<a name='7'></font>
<font color=#447700>!(850) 934-2401 -- fax<a name='8'></font>
<font color=#447700>!lehrter.john@epa.gov      <a name='9'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='10'></font>
<a name='11'>
<font color=#447700>!----------------------------------<a name='12'></font>
<A NAME='CGEM'><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM' TARGET='top_target'><IMG SRC="../../gif/bar_yellow.gif" border=0></A><a name='13'>
      <font color=#993300>PROGRAM  </font><font color=#cc0000>CGEM</font><a name='14'>
<font color=#447700>!----------------------------------<a name='15'></font>
<a name='16'>
<font color=#447700>!------------------------------------------------------------------------<a name='17'></font>
<font color=#447700>!     Written  by :: Lisa L. Lowe/EMVL, lowe.lisa@epa.gov <a name='18'></font>
<font color=#447700>!                    D.S.Ko/NRL  <a name='19'></font>
<font color=#447700>!                    Barry E. Herchenroder/EMVL <a name='20'></font>
<font color=#447700>!                    Louis Olszyk/EMVL<a name='21'></font>
<font color=#447700>!                    Wei Tang/EMVL<a name='22'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='23'></font>
<a name='24'>
<font color=#447700>!--------------------------------------------------------------<a name='25'></font>
<font color=#447700>!     Code to solve the Transport Equation:<a name='26'></font>
<font color=#447700>!<a name='27'></font>
<font color=#447700>!        dF/dt = dFu/dx+dFv/dy+dFw/dz     advection<a name='28'></font>
<font color=#447700>!                + d(Kh*dF/dz)/dz     vertical mixing<a name='29'></font>
<font color=#447700>!                + Q           source/sink incl river<a name='30'></font>
<font color=#447700>!                                         (in rate of change)<a name='31'></font>
<font color=#447700>!<a name='32'></font>
<font color=#447700>!     by apply one time step, upwind advection<a name='33'></font>
<font color=#447700>!     with vertical mixing<a name='34'></font>
<font color=#447700>!     Source/sink is provided by GEM_EPA<a name='35'></font>
<font color=#447700>!<a name='36'></font>
<font color=#447700>!     Work in sigma layers &lt;= max. sigma level<a name='37'></font>
<font color=#447700>!     Need e/t/s/Ux/Vx/Wx/Kh outputs from EPACOMv5<a name='38'></font>
<font color=#447700>!--------------------------------------------------------------<a name='39'></font>
<a name='40'>
     USE <A href='../../html_code/CGEM_2.0/Model_dim.f.html#MODEL_DIM'>Model_dim</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_DIM_11"><a name='41'>
     USE <A href='../../html_code/CGEM_2.0/INPUT_VARS.f.html#INPUT_VARS'>INPUT_VARS</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_VARS_9"> <font color=#447700>! For RESTART_FILE_TIMESTEP, etc.<a name='42'></font>
     USE <A href='../../html_code/CGEM_2.0/MPI_dim.f.html#MPI_DIM'>MPI_dim</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MPI_DIM_7"><a name='43'>
     USE <A href='../../html_code/CGEM_2.0/CGEM_vars.f.html#CGEM_VARS'>CGEM_vars</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CGEM_VARS_5"> <a name='44'>
     USE <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#OUTPUT_NETCDF'>OUTPUT_NETCDF</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_NETCDF_2"><a name='45'>
     USE <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#DATE_TIME'>DATE_TIME</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DATE_TIME_3"> <font color=#447700>! For TOTAL_SECONDS, DATE_TIMESTAMP.<a name='46'></font>
<a name='47'>
     IMPLICIT NONE<a name='48'>
<a name='49'>
     include "mpif.h"<a name='50'>
<a name='51'>
<font color=#447700>!---------------------<a name='52'></font>
<font color=#447700>! Declare Output parameters:    <a name='53'></font>
<font color=#447700>!---------------------<a name='54'></font>
     character(100) :: BASE_NETCDF_OUTPUT_FILE_NAME<a name='55'>
     integer, parameter :: TIMESTEPS_PER_OUTPUT_FILE = 1000 <font color=#447700>! Chunkify NetCDF output<a name='56'></font>
     character(256) NETCDF_OUTPUT_FILE_NAME<a name='57'>
     <font color=#447700>! If restarting, this is the name of the previous NetCDF output file.<a name='58'></font>
     character(256),parameter:: RESTART_FILE_NAME = './NETCDF/restart.nc'<a name='59'>
     INTEGER(8) LAST_TIMESTEP_SECONDS <font color=#447700>! last time variable written in restart NetCDF file<a name='60'></font>
     integer FILE_START <font color=#447700>! Start time step of a chunkified NetCDF file<a name='61'></font>
<a name='62'>
     integer, parameter :: exit_code = 0 <font color=#447700>! Status will be 0 when end<a name='63'></font>
                                         <font color=#447700>! of a successful run occurs.<a name='64'></font>
<a name='65'>
<font color=#447700>!-----------------<a name='66'></font>
           <a name='67'>
     real(kind=8), parameter :: SDay_8   = 86400.0_8       <font color=#447700>! secs in a day<a name='68'></font>
     integer  :: i, j, k, isp <font color=#447700>!loop variables<a name='69'></font>
     integer  :: iYr, iMon, iDay, iHr, iMin, iSec <font color=#447700>!Time variables<a name='70'></font>
     integer  :: YrS, MonS, DayS, HrS, MinS, SecS <font color=#447700>!Original start time for NetCDF global attibutes<a name='71'></font>
<a name='72'>
     integer  :: iout  <font color=#447700>!the output time-interval in timesteps<a name='73'></font>
     integer  :: istat <font color=#447700>!status variable      <a name='74'></font>
                             <a name='75'>
     integer  :: istep <font color=#447700>!current time step        <a name='76'></font>
     integer  :: istep_out <font color=#447700>!current output counter <a name='77'></font>
     integer  :: istep_start <font color=#447700>!time loop start<a name='78'></font>
     integer  :: istep_end <font color=#447700>!time loop end<a name='79'></font>
<a name='80'>
     integer  :: istep_wait <font color=#447700>!How many timesteps before 0600 hours (printing averages)<a name='81'></font>
     integer  :: print_ave  <font color=#447700>!How many timesteps in a day (printing averages)<a name='82'></font>
<a name='83'>
     integer  :: ns    <font color=#447700>!dummy read in variable<a name='84'></font>
     integer  :: nstep <font color=#447700>!total number of timesteps in a run <a name='85'></font>
     integer  :: nzr   <font color=#447700>!dummy read in variable <a name='86'></font>
<a name='87'>
     real         :: Hs <font color=#447700>!Reference water thickness          <a name='88'></font>
     integer(kind=8) :: TC_8 <font color=#447700>! Current time in seconds since Model_dim::iYr0.<a name='89'></font>
     integer(kind=8) :: START_SECONDS <font color=#447700>! Seconds from iYr0 to start of run.<a name='90'></font>
     integer(kind=8) :: END_SECONDS   <font color=#447700>! Seconds from iYr0 to end of run.<a name='91'></font>
     integer(kind=8) :: SECONDS_RAN   <font color=#447700>! Seconds since start of run<a name='92'></font>
<a name='93'>
     real, dimension(myimp2,jm)     ::   RadBotOut_ij  <font color=#447700>!Irradiance at bottom of cell<a name='94'></font>
     real, dimension(myimp2,jm,nsl) ::   CBODW         <font color=#447700>!Chem. Bio. O2 Demand in the water<a name='95'></font>
     real, dimension(im,jm,nsl) ::       d_sfc         <font color=#447700>!Distance from surface to center of cell<a name='96'></font>
<a name='97'>
     real     :: Vol(im,jm,nsl),Volf(im,jm,nsl),Volij <font color=#447700>!To calculate cell volume<a name='98'></font>
<a name='99'>
     real lat(jm),lon(im) <font color=#447700>!Latitude and longitude of each grid cell<a name='100'></font>
     real h(im,jm),d(im,jm) <font color=#447700>!h=water depth at cell center, d=h+elevation E <a name='101'></font>
     real E(im,jm,1),Kh(im,jm,kbm1) <font color=#447700>!E=surface elevation, Kh=vertical eddy diffusivity<a name='102'></font>
     real S(im,jm,kbm1),T(im,jm,kbm1)<font color=#447700>!S=Salinity in psu, T=temperature in Celsius<a name='103'></font>
     real Ux(im,jm,nsl),Vx(im,jm,nsl),Wx(im,jm,nsl) <font color=#447700>!Currents: velocity fluxes<a name='104'></font>
<a name='105'>
     real f(myimp2,jm,nsl,nf) <font color=#447700>!Array that holds value of 41 state variables<a name='106'></font>
     real dxdy(im,jm),dxy(jm) <font color=#447700>!dxdy=area for each grid, dxy=with across center of cell<a name='107'></font>
<a name='108'>
     real zl(kb),zz(kb) <font color=#447700>!zl=sigma at top of k, zz= sigma value at mid k<a name='109'></font>
     real dz(kb),dzz(kb) <font color=#447700>!dz=sigma thickness of layer k, dzz= zz(k+1)-zz(k)<a name='110'></font>
<a name='111'>
     real Rad(im,jm),Wind(im,jm) <font color=#447700>!Rad=Irradiance at top of sea surface, Wind= Wind velocity (m/s)<a name='112'></font>
<a name='113'>
     real wtrv(nsl,nr) <font color=#447700>!River flow weights<a name='114'></font>
     integer irv(nr),jrv(nr) <font color=#447700>!Holds i,j cell values for the nr rivers<a name='115'></font>
#IFNDEF _3D<a name='116'>
     integer lcent <font color=#447700>!For 1D, defines river cell (&gt;0)<a name='117'></font>
#ENDIF<a name='118'>
     integer fm(im,jm)  <font color=#447700>! land(0)/sea(1) mask<a name='119'></font>
     integer fm2(im,jm) <font color=#447700>! Modified land(0)/sea(1) mask (counts lateral BCs as land)<a name='120'></font>
     real wsm(im,jm)    <font color=#447700>! shelf(0)/open ocean(1) mask<a name='121'></font>
     real khm(im,jm,nz) <font color=#447700>! Multiplication factor mask for Kh<a name='122'></font>
<a name='123'>
<font color=#447700>!---------------------<a name='124'></font>
<font color=#447700>! Character variables <a name='125'></font>
<font color=#447700>!---------------------<a name='126'></font>
      character fn*80  <font color=#447700>!Generic file name holder <a name='127'></font>
      character*8 Which_hydro_c <font color=#447700>!command line input for hydro<a name='128'></font>
#ifdef DEBUG       <a name='129'>
      character*120 output_filename <font color=#447700>!Output file for debugging<a name='130'></font>
#endif<a name='131'>
      character*120 input_filename <font color=#447700>!Input file<a name='132'></font>
<font color=#447700>!------------------------------------------------ <a name='133'></font>
<a name='134'>
<font color=#447700>!---------------------<a name='135'></font>
<font color=#447700>! MPI variables<a name='136'></font>
<font color=#447700>!---------------------<a name='137'></font>
      integer myid,numprocs,mpierr,myi <font color=#447700>!processor id, # processors, error id, # columns on myid<a name='138'></font>
      integer my_imstart,my_imend <font color=#447700>!starting and ending i index for processor myid<a name='139'></font>
      integer my_im               <font color=#447700>!number of columns for processor myid<a name='140'></font>
      integer itot, istart, iend, fstart, fend  <font color=#447700>!for netCDF calls<a name='141'></font>
      integer jtot, jstart, jend        <font color=#447700>!for netCDF calls<a name='142'></font>
      real*8  mpitime1,mpitime2   <font color=#447700>!timing<a name='143'></font>
      <a name='144'>
<font color=#447700>!Command line<a name='145'></font>
      integer :: c_count<a name='146'>
<font color=#447700>!PEANUT<a name='147'></font>
      real :: uprimebar, vprimebar, wprimebar<a name='148'>
      integer :: n_outsteps<a name='149'>
<a name='150'>
<font color=#447700>!------------------------------------------------<a name='151'></font>
<font color=#447700>!Initialize MPI<a name='152'></font>
      call MPI_INIT(mpierr)<a name='153'>
      call MPI_COMM_RANK(MPI_COMM_WORLD, myid, mpierr)<a name='154'>
      call MPI_COMM_SIZE(MPI_COMM_WORLD, numprocs, mpierr)<a name='155'>
      mpitime1 = MPI_WTIME()<a name='156'>
<a name='157'>
#IFNDEF _3D<a name='158'>
      if(numprocs.ne.1) then<a name='159'>
           write(6,*) "1D, please run on 1 processor only"<a name='160'>
           call MPI_FINALIZE(mpierr)<a name='161'>
           stop<a name='162'>
      endif<a name='163'>
#ENDIF<a name='164'>
<a name='165'>
<font color=#447700>!Divide grid among processors<a name='166'></font>
      call <A href='../../html_code/CGEM_2.0/Decomp1D.f.html#DECOMP1D'>Decomp1D</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DECOMP1D_2">(im, numprocs, myid, my_imstart, my_imend)<a name='167'>
<a name='168'>
<font color=#447700>!Define Loop Bounds<a name='169'></font>
      my_im = my_imend - my_imstart + 1<a name='170'>
<a name='171'>
<font color=#447700>! --- Command Line Arguments for file names ---<a name='172'></font>
      if(myid.eq.0) then<a name='173'>
       c_count = command_argument_count()<a name='174'>
         BASE_NETCDF_OUTPUT_FILE_NAME = './NETCDF/output.'<a name='175'>
         input_filename = "GEM_InputFile"<a name='176'>
         Which_hydro_c = "Present"<a name='177'>
       if (c_count.eq.1) then<a name='178'>
         call get_command_argument(1,Which_hydro_c)<a name='179'>
       elseif (c_count.eq.2) then<a name='180'>
         call get_command_argument(1,Which_hydro_c)<a name='181'>
         call get_command_argument(2,BASE_NETCDF_OUTPUT_FILE_NAME)<a name='182'>
       elseif (c_count.eq.3) then<a name='183'>
         call get_command_argument(1,Which_hydro_c)<a name='184'>
         call get_command_argument(2,BASE_NETCDF_OUTPUT_FILE_NAME)<a name='185'>
         call get_command_argument(3,input_filename)<a name='186'>
       endif<a name='187'>
        if(Which_hydro_c.eq.'cc0') then       <font color=#447700>!Climate change cc0<a name='188'></font>
           Which_hydro = 1<a name='189'>
           write(6,*) "Hydro data is in hydro_input.dir.cc0"<a name='190'>
        elseif (Which_hydro_c.eq.'cc1') then  <font color=#447700>!Climate change cc1<a name='191'></font>
           Which_hydro = 2<a name='192'>
           write(6,*) "Hydro data is in hydro_input.dir.cc1"<a name='193'>
        else  <font color=#447700>!Default is "present" hydro<a name='194'></font>
           Which_hydro = 0<a name='195'>
           write(6,*) "Hydro data is in hydro_input.dir.EPA2_old"<a name='196'>
        endif<a name='197'>
       write(6,*) "Base Outputfile Name will be: ",trim(BASE_NETCDF_OUTPUT_FILE_NAME)<a name='198'>
       write(6,*) "Inputfile will be: ",trim(input_filename)<a name='199'>
      endif<a name='200'>
      if(numprocs.gt.1) call MPI_BCAST(BASE_NETCDF_OUTPUT_FILE_NAME,100,MPI_CHARACTER,0,MPI_COMM_WORLD,mpierr)<a name='201'>
      call MPI_BARRIER(MPI_COMM_WORLD,mpierr)<a name='202'>
<a name='203'>
<a name='204'>
<font color=#447700>! --- Inputs ----------------------------------------------------<a name='205'></font>
<font color=#447700>!----------------------<a name='206'></font>
<font color=#447700>! --- get grid location<a name='207'></font>
<font color=#447700>!----------------------<a name='208'></font>
   if (myid .eq. 0) then<a name='209'>
<font color=#447700>!----------------------------------------<a name='210'></font>
      fn = TRIM(HYDRODIR//'latlon.dat')<a name='211'>
      open (19,file=fn,status='old')<a name='212'>
      read (19,*) <a name='213'>
      read (19,*) lat<a name='214'>
      read (19,*) lon <a name='215'>
      close(19)<a name='216'>
<a name='217'>
<font color=#447700>!--------------------      <a name='218'></font>
<font color=#447700>! --- get model depth<a name='219'></font>
<font color=#447700>!--------------------<a name='220'></font>
<font color=#447700>!--------------------------------------<a name='221'></font>
      fn = TRIM(HYDRODIR//'TopoS.dat')            <a name='222'>
      open (19,file=fn,status='old')<a name='223'>
      read (19,*) <a name='224'>
      read (19,*) h      <font color=#447700>! This is the undisturbed water depth at <a name='225'></font>
      close(19)          <font color=#447700>!  the center of cells <a name='226'></font>
   endif                 <a name='227'>
   if(numprocs.gt.1) then<a name='228'>
      call MPI_BCAST(lat,jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='229'>
      call MPI_BCAST(lon,im,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='230'>
      call MPI_BCAST(h,im*jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='231'>
   endif<a name='232'>
<a name='233'>
<font color=#447700>!----------------------------------------------------------------------	 <a name='234'></font>
<font color=#447700>! --- create a land-sea mask (land=0;ocean=1)<a name='235'></font>
<font color=#447700>!----------------------------------------------------------------------	<a name='236'></font>
      do j = 1,jm<a name='237'>
      do i = 1,im <a name='238'>
          if (h(i,j).gt.1.) then  <font color=#447700>! Mask to determine if cell is land or ocean<a name='239'></font>
            fm(i,j) = 1  <font color=#447700>!ocean cell<a name='240'></font>
          else<a name='241'>
            fm(i,j) = 0  <font color=#447700>!land cell<a name='242'></font>
          endif<a name='243'>
        enddo<a name='244'>
      enddo<a name='245'>
<a name='246'>
      do j = 1, jm<a name='247'>
        do i = 1, im<a name='248'>
          if (h(i,j).le.100) then  <font color=#447700>! Mask to determine if cell is<a name='249'></font>
                                   <font color=#447700>! on the shelf or open ocean<a name='250'></font>
            wsm(i,j) = 0. <font color=#447700>!shelf<a name='251'></font>
          else<a name='252'>
            wsm(i,j) = 1. <font color=#447700>!open ocean<a name='253'></font>
          endif<a name='254'>
        enddo<a name='255'>
      enddo<a name='256'>
<a name='257'>
<font color=#447700>!Alternate Mask: Make lateral boundary cells "land" cells so they aren't modified/looped over in the code:<a name='258'></font>
      fm2(:,:) = fm(:,:)<a name='259'>
      fm2(1,:)  = 0<a name='260'>
      fm2(im,:) = 0<a name='261'>
      fm2(:,1)  = 0<a name='262'>
      fm2(:,jm) = 0<a name='263'>
<a name='264'>
<font color=#447700>! ---------------------------------------------------------------<a name='265'></font>
<font color=#447700>!     Read model parameters<a name='266'></font>
<font color=#447700>! ---------------------------------------------------------------<a name='267'></font>
      if (myid .eq. 0) call <A href='../../html_code/CGEM_2.0/rPointer.f.html#RPOINTER'>rPointer</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RPOINTER_2">(nko, no, io, jo, ko) <a name='268'>
      if(numprocs.gt.1) then<a name='269'>
       call MPI_BCAST(io,no,MPI_INTEGER,0,MPI_COMM_WORLD,mpierr)<a name='270'>
       call MPI_BCAST(jo,no,MPI_INTEGER,0,MPI_COMM_WORLD,mpierr)<a name='271'>
       call MPI_BCAST(ko,no,MPI_INTEGER,0,MPI_COMM_WORLD,mpierr)<a name='272'>
      endif<a name='273'>
<a name='274'>
<font color=#447700>!--------------------------------------<a name='275'></font>
<font color=#447700>! --- get model grid sizes<a name='276'></font>
<font color=#447700>!--------------------------------------<a name='277'></font>
      if(myid.eq.0) then<a name='278'>
       fn = TRIM(HYDRODIR//'dxdy.dat')<a name='279'>
       OPEN (19,FILE=fn,STATUS='OLD')<a name='280'>
       READ (19,*)<a name='281'>
       READ (19,*) dxy <font color=#447700>! Holds dx(j) values, j=1,im; j is row index. <a name='282'></font>
                       <font color=#447700>!  dx(j) is width of cell for row j across center <a name='283'></font>
		       <font color=#447700>!  of the cell. dy = 1890.3164 m. is S-N width of <a name='284'></font>
		       <font color=#447700>!  a cell across the center of the cell<a name='285'></font>
       CLOSE(19)      <a name='286'>
<a name='287'>
<font color=#447700>!---------------------------------------<a name='288'></font>
<font color=#447700>! --- get model vertical grid<a name='289'></font>
<font color=#447700>!---------------------------------------<a name='290'></font>
      fn = TRIM(HYDRODIR//'Depth.dat')<a name='291'>
      OPEN (19,FILE=fn,STATUS='OLD')<a name='292'>
      READ (19,*) nzr,ns,Hs         <font color=#447700>! Hs is a reference<a name='293'></font>
                                    <font color=#447700>!  depth used to calculate<a name='294'></font>
				    <font color=#447700>!  sigma values given depths<a name='295'></font>
				    <font color=#447700>!  of layer surfaces and <a name='296'></font>
				    <font color=#447700>!  centers.<a name='297'></font>
      READ (19,*) zl<a name='298'>
      READ (19,*) zz<a name='299'>
      READ (19,*) dz<a name='300'>
      CLOSE(19)<a name='301'>
     endif  <font color=#447700>!endif myid.eq.0<a name='302'></font>
     if(numprocs.gt.1) then<a name='303'>
      call MPI_BCAST(dxy,jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='304'>
      call MPI_BCAST(Hs,1,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='305'>
      call MPI_BCAST(zl,kb,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='306'>
      call MPI_BCAST(zz,kb,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='307'>
      call MPI_BCAST(dz,kb,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='308'>
     endif<a name='309'>
<a name='310'>
<font color=#447700>!---------------------------------------------------------------------<a name='311'></font>
<font color=#447700>!     ns : no. of sigma levels at center of sigma layers, i.e. the number<a name='312'></font>
<font color=#447700>!     of sigma layers- convert dz,zl,zz to sigma by dividing thru by the<a name='313'></font>
<font color=#447700>!     reference water thickness, Hs <a name='314'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='315'></font>
      do k = 1, nsl<a name='316'>
         dz(k) = dz(k)/Hs   <font color=#447700>! dz(k) on RHS is thickness (m) of layer k<a name='317'></font>
                            <font color=#447700>! On LHS, dz(k) is sigma thickness of layer k<a name='318'></font>
      enddo <a name='319'>
<a name='320'>
<font color=#447700>!------------------------------------------------------------- <a name='321'></font>
<font color=#447700>! In the next loop, we need zl(k=nsl+1) to calculate elevation<a name='322'></font>
<font color=#447700>! (i.e. depth) at the bottom of sigma layer k = nsl, i.e. the<a name='323'></font>
<font color=#447700>! top of layer k = nsl+1.<a name='324'></font>
<font color=#447700>!<a name='325'></font>
<font color=#447700>! In the next loop We also need zz(k=nsl+1) to calculate dzz(nsl)<a name='326'></font>
<font color=#447700>! in the following loop that calculates dzz array elements<a name='327'></font>
<font color=#447700>!-------------------------------------------------------------<a name='328'></font>
      do k = 1, nsl+1<a name='329'>
         zl(k) = zl(k)/Hs   <font color=#447700>! zl(k) on RHS is depth (m) at at top<a name='330'></font>
                            <font color=#447700>!  of layer k with zl(ns+1)=depth at sea<a name='331'></font>
                            <font color=#447700>!  bottom. On LHS, zl(k) is the sigma<a name='332'></font>
                            <font color=#447700>!  value associated with the top interface<a name='333'></font>
                            <font color=#447700>!  of layer k<a name='334'></font>
<a name='335'>
         zz(k) = zz(k)/Hs   <font color=#447700>! zz(k) on RHS is depth (m) at middle of<a name='336'></font>
                            <font color=#447700>!  layer k. on LHS, zz(k) is the sigma<a name='337'></font>
                            <font color=#447700>!  value associated with the middle of<a name='338'></font>
                            <font color=#447700>!  layer k.<a name='339'></font>
      enddo<a name='340'>
<a name='341'>
      do k = 1, nsl               <font color=#447700>! zz(k)   = sigma at middle of layer k<a name='342'></font>
         dzz(k) = zz(k+1)-zz(k)   <font color=#447700>! zz(k+1) = sigma at middle of layer k+1<a name='343'></font>
                                  <font color=#447700>! dzz(k)  = sigma difference between<a name='344'></font>
                                  <font color=#447700>!   middle of layer k+1 and middle of layer k<a name='345'></font>
      enddo<a name='346'>
<a name='347'>
<font color=#447700>!-----------------------------------------------------------------------<a name='348'></font>
      do j = 1, jm<a name='349'>
          do i=1,im<a name='350'>
            dxdy(i,j) = dxy(j)*dxy(j)     <font color=#447700>! Area for each grid = dx*dy<a name='351'></font>
            h(i,j) = amin1(h(i,j),Hs)     <font color=#447700>! Depth for sigma layers, maximum depth 100<a name='352'></font>
         enddo<a name='353'>
      enddo<a name='354'>
<a name='355'>
<font color=#447700>!---------------------------------------------------------------<a name='356'></font>
<font color=#447700>! Read Input Data, from input_filename <a name='357'></font>
<font color=#447700>!------------------------------------------------------------- <a name='358'></font>
      call <A href='../../html_code/CGEM_2.0/Read_InputFile.f.html#READ_INPUTFILE'>Read_InputFile</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_INPUTFILE_2">(input_filename,lat,lon,myid,numprocs)<a name='359'>
<a name='360'>
      <font color=#447700>! Save the original start time for defining NetCDF global attibutes,<a name='361'></font>
      <font color=#447700>! in case of crash restart, the values of i**S will be overwritten.<a name='362'></font>
       YrS = iYrS<a name='363'>
       MonS = iMonS<a name='364'>
       DayS = iDayS<a name='365'>
       HrS = iHrS<a name='366'>
       MinS = iMinS<a name='367'>
       SecS = iSecS<a name='368'>
<a name='369'>
       START_SECONDS = &amp;<a name='370'>
         <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#TOTAL_SECONDS'>TOTAL_SECONDS</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOTAL_SECONDS_6">( iYr0, iYrS, iMonS, iDayS, iHrS, iMinS, iSecS )<a name='371'>
<a name='372'>
      <font color=#447700>! Compute RESTART_FILE_TIMESTEP if restarting (regular or due to a crash):<a name='373'></font>
<a name='374'>
      LAST_TIMESTEP_SECONDS = 0<a name='375'>
      SECONDS_RAN = 0<a name='376'>
<a name='377'>
      IF ( InitializeHow .EQ. 1 .OR. InitializeHow .EQ. 2 ) THEN <font color=#447700>! Restarting:<a name='378'></font>
        RESTART_FILE_TIMESTEP =                                         &amp;<a name='379'>
          <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#LAST_NETCDF_TIMESTEP'>LAST_NETCDF_TIMESTEP</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LAST_NETCDF_TIMESTEP_2">( RESTART_FILE_NAME,                      &amp;<a name='380'>
                                iYrS, iMonS, iDayS, iHrS, iMinS, iSecS, &amp;<a name='381'>
                                iYrE, iMonE, iDayE, iHrE, iMinE, iSecE, &amp;<a name='382'>
                                dT_out, InitializeHow .EQ. 2,           &amp;<a name='383'>
                                LAST_TIMESTEP_SECONDS )<a name='384'>
<a name='385'>
        <font color=#447700>! Crash restart, new start time<a name='386'></font>
        IF ( InitializeHow .EQ. 2 ) THEN<a name='387'>
            SECONDS_RAN = LAST_TIMESTEP_SECONDS - START_SECONDS<a name='388'>
            CALL <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#DATE_TIMESTAMP'>DATE_TIMESTAMP</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DATE_TIMESTAMP_3">( iYr0, LAST_TIMESTEP_SECONDS, &amp;<a name='389'>
                                 iYrS, iMonS, iDayS, iHrS, iMinS, iSecS )<a name='390'>
        END IF<a name='391'>
      END IF<a name='392'>
<a name='393'>
      if(myid.eq.0.and.Out_1D.eq.1) write(6,*) "icent,jcent",icent,jcent <font color=#447700>!1D data written for this cell<a name='394'></font>
<a name='395'>
#IFNDEF _3D <a name='396'>
      if(fm(icent,jcent).eq.0) then<a name='397'>
        write(6,*) "You have chosen a land cell",icent,jcent<a name='398'>
        write(6,*) "Lat/Lon=",lat(jcent),lon(icent)<a name='399'>
        write(6,*) "Please change and run again."<a name='400'>
        call MPI_FINALIZE(mpierr)<a name='401'>
        stop<a name='402'>
      endif<a name='403'>
#ENDIF<a name='404'>
<a name='405'>
<a name='406'>
<font color=#447700>! Indices definitions for 1D vs 3D, and for netCDF<a name='407'></font>
#IFDEF _3D<a name='408'>
      fstart = 2<a name='409'>
      fend = my_im + 1<a name='410'>
      istart = my_imstart <a name='411'>
      iend = my_imend <a name='412'>
      jstart = 1<a name='413'>
      jend = jm<a name='414'>
      itot = im <a name='415'>
      jtot = jm<a name='416'>
#ELSE<a name='417'>
      i = icent<a name='418'>
      j = jcent<a name='419'>
      myi = icent + 1 <a name='420'>
      fstart = icent + 1<a name='421'>
      fend = icent + 1<a name='422'>
      istart = icent<a name='423'>
      jstart = jcent<a name='424'>
      iend = icent<a name='425'>
      jend = jcent<a name='426'>
      itot = 1<a name='427'>
      jtot = 1<a name='428'>
      my_im = 1<a name='429'>
#ENDIF<a name='430'>
<a name='431'>
<a name='432'>
#ifdef DEBUG<a name='433'>
<font color=#447700>!This will check if Read_InputFile is correctly reading and broadcasting<a name='434'></font>
      if(myid.eq.0) then<a name='435'>
       output_filename = "Debug_InputFile0"<a name='436'>
       call <A href='../../html_code/CGEM_2.0/Write_InputFile.f.html#WRITE_INPUTFILE'>Write_InputFile</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_INPUTFILE_3">(output_filename)<a name='437'>
      endif<a name='438'>
      if(myid.eq.1) then<a name='439'>
       output_filename = "Debug_InputFile1"<a name='440'>
       call <A href='../../html_code/CGEM_2.0/Write_InputFile.f.html#WRITE_INPUTFILE'>Write_InputFile</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_INPUTFILE_4">(output_filename)<a name='441'>
      endif<a name='442'>
      call MPI_BARRIER(MPI_COMM_WORLD,mpierr)<a name='443'>
      stop<a name='444'>
#endif<a name='445'>
<a name='446'>
<font color=#447700>! Make mask for VMixing Coefficients<a name='447'></font>
      call <A href='../../html_code/CGEM_2.0/Depth_Kh_Mask.f.html#DEPTH_KH_MASK'>Depth_Kh_Mask</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEPTH_KH_MASK_2">(fm,h,khm)<a name='448'>
<a name='449'>
<font color=#447700>! Define when and how often to print intermediate values <a name='450'></font>
      call <A href='../../html_code/CGEM_2.0/Ave_istep_Offset.f.html#AVE_ISTEP_OFFSET'>Ave_istep_offset</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AVE_ISTEP_OFFSET_2">(istep_wait,print_ave)<a name='451'>
<a name='452'>
<font color=#447700>!Set Sinking Rates for Qn/Qp:<a name='453'></font>
       ws(iQn1:iQn6) = ws(iA1:iA6)<a name='454'>
       ws(iQp1:iQp6) = ws(iA1:iA6)<a name='455'>
<a name='456'>
<font color=#447700>!--- END READ INPUT DATA --------------------------------------------<a name='457'></font>
<a name='458'>
<a name='459'>
<font color=#447700>! ------------------<a name='460'></font>
<font color=#447700>!     Initialization<a name='461'></font>
<font color=#447700>! ------------------<a name='462'></font>
 <a name='463'>
<font color=#447700>! --- sinking speed: converted from m/d downward positive to m/s negative<a name='464'></font>
      ws = -ws/SDay_8<a name='465'>
<a name='466'>
      <font color=#447700>! Compute starting time of run in seconds since Model_dim::iYr0:<a name='467'></font>
<a name='468'>
      TC_8 = <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#TOTAL_SECONDS'>TOTAL_SECONDS</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOTAL_SECONDS_7">( iYr0, iYrS, iMonS, iDayS, iHrS, iMinS, iSecS )<a name='469'>
<a name='470'>
<font color=#447700>! Initialize arrays<a name='471'></font>
     E = -9999.<a name='472'>
     Kh = -9999. <a name='473'>
     S = -9999. <a name='474'>
     T = -9999. <a name='475'>
     Ux = 0. <a name='476'>
     Vx = 0. <a name='477'>
     Wx = 0. <a name='478'>
<a name='479'>
<font color=#447700>! Read in initial values<a name='480'></font>
      call <A href='../../html_code/CGEM_2.0/get_Init_EVars.f.html#GET_INIT_EVARS'>get_Init_EVars</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_INIT_EVARS_2">(TC_8,E,d,h,S,T,Kh,fm,myid,numprocs) <a name='481'>
      call <A href='../../html_code/CGEM_2.0/get_Init_UVars.f.html#GET_INIT_UVARS'>get_Init_UVars</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_INIT_UVARS_2">(TC_8,Ux,Vx,Wx,myid,numprocs)<a name='482'>
<a name='483'>
<a name='484'>
<a name='485'>
<font color=#447700>!Redo mask in terms of Ko's variable S, some are undefined at h&lt;=100:<a name='486'></font>
#IFDEF _3D<a name='487'>
      do j = 1, jm<a name='488'>
        do i = 1, im<a name='489'>
#ENDIF<a name='490'>
          if (S(i,j,nsl).le.0) then    <font color=#447700>! Determine if cell is<a name='491'></font>
                                       <font color=#447700>! on the shelf or open ocean<a name='492'></font>
            wsm(i,j) = 0. <font color=#447700>!shelf<a name='493'></font>
          endif<a name='494'>
#IFDEF _3D<a name='495'>
        enddo<a name='496'>
      enddo<a name='497'>
#ENDIF<a name='498'>
<a name='499'>
<font color=#447700>!========================================Initialization of f==================  <a name='500'></font>
<font color=#447700>!Define depth for Initial Conditions <a name='501'></font>
      do k=1,nsl<a name='502'>
#IFDEF _3D<a name='503'>
       do j=1,jm<a name='504'>
        do i=1,im<a name='505'>
#ENDIF<a name='506'>
         d_sfc(i,j,k) = d(i,j)*zz(k) <font color=#447700>!Depth from Surface to center of cell <a name='507'></font>
#IFDEF _3D<a name='508'>
        enddo<a name='509'>
       enddo<a name='510'>
#ENDIF<a name='511'>
      enddo<a name='512'>
<a name='513'>
      IF ( RESTART_FILE_TIMESTEP .NE. 0 ) THEN <font color=#447700>! Re-initialize f from previous NetCDF file:<a name='514'></font>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#READ_DATA'>READ_DATA</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_DATA_2">( RESTART_FILE_NAME, my_imstart, my_im, 1, jtot, 1, nsl, &amp;<a name='515'>
                        RESTART_FILE_TIMESTEP, &amp;<a name='516'>
                        f( fstart : fend, jstart:jend, :, : ) )<a name='517'>
<a name='518'>
        IF ( InitializeHow .EQ. 3 ) THEN<a name='519'>
          <font color=#447700>! Overwrite selective variables with salinity regression equations:<a name='520'></font>
          CALL <A href='../../html_code/CGEM_2.0/Set_Initial_Conditions_Kurtz.f.html#SET_INITIAL_CONDITIONS'>Set_Initial_Conditions</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_INITIAL_CONDITIONS_3">(f,S,d_sfc,T,lat,fm,my_imstart,my_imend)<a name='521'>
        END IF<a name='522'>
<a name='523'>
      ELSE <font color=#447700>! Initialize f array using salinity and depth:<a name='524'></font>
        CALL <A href='../../html_code/CGEM_2.0/Set_Initial_Conditions_Kurtz.f.html#SET_INITIAL_CONDITIONS'>Set_Initial_Conditions</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_INITIAL_CONDITIONS_4">(f,S,d_sfc,T,lat,fm,my_imstart,my_imend)<a name='525'>
      END IF<a name='526'>
<a name='527'>
<font color=#447700>!Values on shelf will be erroneous, set to -9999 as 'land' marker:<a name='528'></font>
      do isp = 1, nf<a name='529'>
#IFDEF _3D<a name='530'>
       do j=1,jm<a name='531'>
          myi = 2<a name='532'>
        do i=my_imstart,my_imend<a name='533'>
#ENDIF<a name='534'>
          if(wsm(i,j).eq.0.) then <font color=#447700>!if shelf<a name='535'></font>
           f(myi,j,nsl,isp) = -9999 <a name='536'>
          endif<a name='537'>
#IFDEF _3D<a name='538'>
          myi = myi + 1<a name='539'>
        enddo<a name='540'>
       enddo<a name='541'>
#ENDIF<a name='542'>
      enddo<a name='543'>
<a name='544'>
<a name='545'>
<font color=#447700>!========End Initialization of f==============================================<a name='546'></font>
<a name='547'>
if(Calibration.eq.1) then<a name='548'>
      call <A href='../../html_code/CGEM_2.0/Output_Data_Calibration_open.f.html#OUTPUT_DATA_CALIBRATION_OPEN'>Output_Data_Calibration_open</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_DATA_CALIBRATION_OPEN_2"><a name='549'>
endif<a name='550'>
<a name='551'>
<font color=#447700>!--- Initialize solar radiation --------------------------------------<a name='552'></font>
if(SolarRad.eq.1) then<a name='553'>
        if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/Read_Solar_bin.f.html#READ_SOLAR'>Read_Solar</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_SOLAR_2">(TC_8,Rad)<a name='554'>
        if(numprocs.gt.1) call MPI_BCAST(Rad,im*jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='555'>
else<a name='556'>
      call <A href='../../html_code/CGEM_2.0/getSolar.f.html#GETSOLAR'>getSolar</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETSOLAR_2">(lon, lat, iYrS, iMonS, iDayS, iHrS, iMinS, iSecS, Rad, my_imstart, my_imend)<a name='557'>
endif<a name='558'>
<a name='559'>
<font color=#447700>!----------------------------------------------------------------------      <a name='560'></font>
<font color=#447700>! Calculate the river related variables and arrays for the initial time.<a name='561'></font>
<font color=#447700>!----------------------------------------------------------------------  <a name='562'></font>
      if(myid.eq.0) call  <A href='../../html_code/CGEM_2.0/river_data_init.f.html#RIVER_DATA_INIT'>river_data_init</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RIVER_DATA_INIT_2">(irv, jrv, wtrv) <a name='563'>
      if(numprocs.gt.1) then<a name='564'>
       call MPI_BCAST(irv,nr,MPI_INTEGER,0,MPI_COMM_WORLD,mpierr)<a name='565'>
       call MPI_BCAST(jrv,nr,MPI_INTEGER,0,MPI_COMM_WORLD,mpierr)<a name='566'>
       call MPI_BCAST(wtrv,nsl*nr,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='567'>
      endif<a name='568'>
<a name='569'>
#IFNDEF _3D<a name='570'>
      call <A href='../../html_code/CGEM_2.0/Is_River_Cell.f.html#IS_RIVER_CELL'>Is_River_Cell</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="IS_RIVER_CELL_2">(irv,jrv,icent,jcent,lcent)<a name='571'>
      if(lcent.ge.1) then<a name='572'>
         write(6,*) "Cell",i,j,"is river cell number",lcent<a name='573'>
         write(6,*) "Lat/Lon=",lat(jcent),lon(icent)<a name='574'>
         write(6,*) "Do not use 1D for River Cells"<a name='575'>
         write(6,*) "Change i,j or long/lat coords"<a name='576'>
         call MPI_FINALIZE(mpierr)<a name='577'>
         stop<a name='578'>
      endif<a name='579'>
#ENDIF<a name='580'>
<a name='581'>
<font color=#447700>!---------------------------------------------------<a name='582'></font>
<font color=#447700>! Calc nstep , the total number of timesteps in a run	<a name='583'></font>
<font color=#447700>!---------------------------------------------------       <a name='584'></font>
<a name='585'>
      START_SECONDS = &amp;<a name='586'>
        <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#TOTAL_SECONDS'>TOTAL_SECONDS</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOTAL_SECONDS_8">( iYr0, iYrS, iMonS, iDayS, iHrS, iMinS, iSecS )<a name='587'>
<a name='588'>
      END_SECONDS = &amp;<a name='589'>
        <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#TOTAL_SECONDS'>TOTAL_SECONDS</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOTAL_SECONDS_9">( iYr0, iYrE, iMonE, iDayE, iHrE, iMinE, iSecE )<a name='590'>
<a name='591'>
      nstep = ( END_SECONDS - START_SECONDS ) / dT<a name='592'>
<a name='593'>
<font color=#447700>!----------------------------------------------------------------------    <a name='594'></font>
<font color=#447700>! Set  iout, the output time-interval in timesteps. <a name='595'></font>
<font color=#447700>! The total number of time-levels output to the NetCDF file is istep_out + 1,<a name='596'></font>
<font color=#447700>! including the output for the initial time in the output time-interval.<a name='597'></font>
<font color=#447700>!----------------------------------------------------------------------- <a name='598'></font>
      iout = dT_out/dT <a name='599'>
      istep = 0<a name='600'>
      istep_out = 0<a name='601'>
      istep_start = 1<a name='602'>
<a name='603'>
      IF ( InitializeHow .EQ. 2 ) THEN<a name='604'>
      <font color=#447700>! When crash restart, the time loop start and output start need to be changed.<a name='605'></font>
        istep_out = SECONDS_RAN / dT_out<a name='606'>
        istep_start = istep_out * iout + 1<a name='607'>
      END IF<a name='608'>
<a name='609'>
      istep_end = istep_start + nstep - 1<a name='610'>
<a name='611'>
<font color=#447700>!--- Volume for each grid (counted the free surface)<a name='612'></font>
#IFDEF _3D<a name='613'>
      Vol = -9999 <a name='614'>
      do j = 1,jm<a name='615'>
       do i = 1,im<a name='616'>
        if(fm(i,j).eq.1) then<a name='617'>
#ENDIF<a name='618'>
         Volij = d(i,j)*dxdy(i,j)<a name='619'>
          do k = 1, nsl<a name='620'>
           Vol(i,j,k) = Volij*dz(k)<a name='621'>
          enddo<a name='622'>
#IFDEF _3D<a name='623'>
        endif<a name='624'>
       enddo<a name='625'>
      enddo<a name='626'>
#ENDIF<a name='627'>
<a name='628'>
<a name='629'>
    n_outsteps = nstep/iout<a name='630'>
    write(6,*) "n_outsteps",n_outsteps+1  <font color=#447700>!Plus this initial time<a name='631'></font>
    uprimebar = 0. <a name='632'>
    vprimebar = 0. <a name='633'>
    wprimebar = 0. <a name='634'>
<a name='635'>
    uprimebar = uprimebar + Ux(i,j,nz)*Ux(i,j,nz)/dxdy(i,j)/(d(i,j)*dz(nz))/(d(i,j)*dz(nz))/n_outsteps<a name='636'>
    vprimebar = vprimebar + Vx(i,j,nz)*Vx(i,j,nz)/dxdy(i,j)/(d(i,j)*dz(nz))/(d(i,j)*dz(nz))/n_outsteps<a name='637'>
    wprimebar = wprimebar + Wx(i,j,nz)*Wx(i,j,nz)/dxdy(i,j)/dxdy(i,j)/n_outsteps<a name='638'>
<a name='639'>
<a name='640'>
<a name='641'>
#IFDEF PEANUT<a name='642'>
<font color=#447700>!-- First process creates the output NetCDF file with static data: --------<a name='643'></font>
<a name='644'>
      WRITE ( NETCDF_OUTPUT_FILE_NAME, '(A, I6.6, A)' )&amp;<a name='645'>
              trim(BASE_NETCDF_OUTPUT_FILE_NAME), istep_out, '.nc'<a name='646'>
<a name='647'>
      IF ( myid .EQ. 0 ) THEN<a name='648'>
<a name='649'>
        <font color=#447700>! Create a new NetCDF file in non-crash-restart cases only:<a name='650'></font>
        IF ( InitializeHow .NE. 2 ) THEN<a name='651'>
          CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#CREATE_FILE'>CREATE_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CREATE_FILE_3">( trim(NETCDF_OUTPUT_FILE_NAME), &amp;<a name='652'>
                            itot, jtot, nsl, &amp;<a name='653'>
                            nstep, &amp;<a name='654'>
                            iYr0, &amp;<a name='655'>
                            YRS, MONS, DAYS, HRS, MINS, SECS, &amp;<a name='656'>
                            IYRE, IMONE, IDAYE, IHRE, IMINE, ISECE, &amp;<a name='657'>
                            DT_OUT, &amp;<a name='658'>
#IFDEF _3D<a name='659'>
                            LON, LAT, H, FM, &amp;<a name='660'>
#ELSE<a name='661'>
                            LON(icent), LAT(jcent), H(icent,jcent), FM(icent,jcent), &amp;<a name='662'>
#ENDIF<a name='663'>
                            ZL, ZZ, DZ )<a name='664'>
          CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#CLOSE_FILE'>CLOSE_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_FILE_5">()<a name='665'>
        END IF<a name='666'>
      END IF<a name='667'>
      CALL MPI_BARRIER( MPI_COMM_WORLD, mpierr ) <font color=#447700>! Wait until file is created.<a name='668'></font>
<a name='669'>
<font color=#447700>! Each process opens the output file for writing:<a name='670'></font>
      IF ( InitializeHow .EQ. 2 ) THEN<a name='671'>
        <font color=#447700>! Chunked file starting timestep:<a name='672'></font>
        FILE_START = INT(istep_out/TIMESTEPS_PER_OUTPUT_FILE) * TIMESTEPS_PER_OUTPUT_FILE<a name='673'>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#OPEN_FILE'>OPEN_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_FILE_4">( trim(RESTART_FILE_NAME), FILE_START ) <font color=#447700>! Append to crashed file.<a name='674'></font>
      ELSE<a name='675'>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#OPEN_FILE'>OPEN_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_FILE_5">( trim(NETCDF_OUTPUT_FILE_NAME), 0 )<a name='676'>
      END IF<a name='677'>
<a name='678'>
      CALL MPI_BARRIER( MPI_COMM_WORLD, mpierr ) <font color=#447700>! Wait until file is opened<a name='679'></font>
<a name='680'>
<font color=#447700>!------- End open netCDF file ------------------------------------------------<a name='681'></font>
<a name='682'>
      <font color=#447700>! Write initial configuration in non-crash-restart cases only:<a name='683'></font>
<a name='684'>
      IF ( InitializeHow .NE. 2 ) THEN<a name='685'>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#WRITE_SUBSET_DATA'>WRITE_SUBSET_DATA</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_SUBSET_DATA_3">( my_imstart, my_im, 1, jtot, 1, nsl, 0, &amp;<a name='686'>
                                f( fstart : fend, jstart:jend, :, : ) )<a name='687'>
        CALL MPI_BARRIER( MPI_COMM_WORLD, mpierr ) <font color=#447700>! Wait until file is updated.<a name='688'></font>
<a name='689'>
<font color=#447700>!--- Initialize growth and irradiance variables for initial netCDF file<a name='690'></font>
        call <A href='../../html_code/CGEM_2.0/GEM_EPA_INIT.f.html#GEM_EPA_INIT'>GEM_EPA_INIT</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEM_EPA_INIT_2">(lat, lon, zl, TC_8, Rad, T, zz, S, dz, d, f,  &amp;<a name='691'>
                          my_imstart,my_imend,fm2,wsm,istep_out, &amp;<a name='692'>
                          RESTART_FILE_NAME, RESTART_FILE_TIMESTEP )<a name='693'>
      END IF<a name='694'>
<a name='695'>
<font color=#447700>!Peanut<a name='696'></font>
#ENDIF<a name='697'>
<a name='698'>
<font color=#447700>!-----------------------<a name='699'></font>
<font color=#447700>! Initialization is done<a name='700'></font>
<font color=#447700>!-----------------------<a name='701'></font>
<a name='702'>
<font color=#447700>!---------------------------<a name='703'></font>
<font color=#447700>! Beginning of the time-loop<a name='704'></font>
<font color=#447700>!---------------------------<a name='705'></font>
<a name='706'>
      TC_8 = START_SECONDS - dT / 2 <font color=#447700>! Subtract half dT to 'center' of timestep.<a name='707'></font>
<a name='708'>
<font color=#447700>!-------------- START TIME LOOP -----------------------------------<a name='709'></font>
      do istep = istep_start, istep_end<a name='710'>
       TC_8 = TC_8 + dT<a name='711'>
<a name='712'>
<font color=#447700>!------------------------------------------------------------------<a name='713'></font>
<font color=#447700>! Calculate iYr, iMon, iDay, iHr, iMin, iSec which <a name='714'></font>
<font color=#447700>! corresponds to the model timestamp, since iYr0 + TC_8 seconds.<a name='715'></font>
<font color=#447700>!------------------------------------------------------------------<a name='716'></font>
<a name='717'>
       CALL <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#DATE_TIMESTAMP'>DATE_TIMESTAMP</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DATE_TIMESTAMP_4">( iYr0, TC_8, &amp;<a name='718'>
                            iYr, iMon, iDay, iHr, iMin, iSec )<a name='719'>
<a name='720'>
if(OUT_1D.eq.1) then<a name='721'>
      <font color=#447700>!Write out 1D ascii file for R<a name='722'></font>
      call <A href='../../html_code/CGEM_2.0/Output_Data_1D.f.html#OUTPUT_DATA_1D_TEXT'>Output_Data_1D_text</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_DATA_1D_TEXT_2">(f,my_imstart,my_imend,istep,icent,jcent)<a name='723'>
endif<a name='724'>
<a name='725'>
<a name='726'>
<a name='727'>
<a name='728'>
<a name='729'>
<a name='730'>
<a name='731'>
<a name='732'>
<font color=#447700>!---------This is the part we need to calculate shear:--------------------------<a name='733'></font>
<a name='734'>
<font color=#447700>!------------------------------------------------------------------<a name='735'></font>
<font color=#447700>! Read E, T, S, Kh, Ux, Vx, and Wx for TC_8<a name='736'></font>
<font color=#447700>!------------------------------------------------------------------<a name='737'></font>
      if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/gEPAssh.f.html#GEPASSH'>gEPAssh</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEPASSH_2"> (TC_8, E, istat) <a name='738'>
      if(numprocs.gt.1) then<a name='739'>
       call MPI_BCAST(E,im*jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='740'>
      endif<a name='741'>
<a name='742'>
      if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/gEPA_Tinterp.f.html#GEPA_TINTERP'>gEPA_Tinterp</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEPA_TINTERP_2"> (TC_8, T,S,Kh, istat) <a name='743'>
      if(numprocs.gt.1) then<a name='744'>
       call MPI_BCAST(T,im*jm*kbm1,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='745'>
       call MPI_BCAST(S,im*jm*kbm1,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='746'>
       call MPI_BCAST(Kh,im*jm*kbm1,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='747'>
      endif<a name='748'>
<a name='749'>
      if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/gEPAflx_Tinterp.f.html#GEPAFLX_TINTERP'>gEPAflx_Tinterp</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEPAFLX_TINTERP_2">(TC_8,Ux,Vx,Wx,istat)<a name='750'>
      if(numprocs.gt.1) then<a name='751'>
       call MPI_BCAST(Ux,im*jm*nsl,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='752'>
       call MPI_BCAST(Vx,im*jm*nsl,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='753'>
       call MPI_BCAST(Wx,im*jm*nsl,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='754'>
      endif<a name='755'>
<a name='756'>
<font color=#447700>!----------------------------------------------------------------- <a name='757'></font>
<font color=#447700>! --- total stillwater thickness d (m.)for all sigma layers including <a name='758'></font>
<font color=#447700>!     the free surface. <a name='759'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='760'></font>
#IFDEF _3D<a name='761'>
      do j = 1,jm<a name='762'>
       do i = 1,im<a name='763'>
#ENDIF<a name='764'>
          d(i,j) = h(i,j)+E(i,j,1)                <a name='765'>
#IFDEF _3D<a name='766'>
       enddo                                       <a name='767'>
      enddo                  <a name='768'>
#ENDIF<a name='769'>
<a name='770'>
<a name='771'>
if (  mod( istep, iout ) .eq. 0 ) then<a name='772'>
<a name='773'>
    write(6,*) "istep=", istep<a name='774'>
<a name='775'>
    uprimebar = uprimebar + Ux(i,j,nz)*Ux(i,j,nz)/dxdy(i,j)/(d(i,j)*dz(nz))/(d(i,j)*dz(nz))/n_outsteps<a name='776'>
    vprimebar = vprimebar + Vx(i,j,nz)*Vx(i,j,nz)/dxdy(i,j)/(d(i,j)*dz(nz))/(d(i,j)*dz(nz))/n_outsteps<a name='777'>
    wprimebar = wprimebar + Wx(i,j,nz)*Wx(i,j,nz)/dxdy(i,j)/dxdy(i,j)/n_outsteps<a name='778'>
<a name='779'>
endif<a name='780'>
<font color=#447700>!------End need to calculate shear------------------------------------------<a name='781'></font>
<a name='782'>
<a name='783'>
<a name='784'>
<a name='785'>
<a name='786'>
<a name='787'>
#IFDEF PEANUT<a name='788'>
<a name='789'>
<font color=#447700>!--- Total Volume for all sigma layers including the free surface<a name='790'></font>
#IFDEF _3D<a name='791'>
      Volf=-9999<a name='792'>
      do j = 1,jm<a name='793'>
       do i = 1,im<a name='794'>
        if(fm(i,j).eq.1) then<a name='795'>
#ENDIF<a name='796'>
         Volij = d(i,j)*dxdy(i,j)<a name='797'>
         do k = 1, nsl<a name='798'>
          Volf(i,j,k) = Volij*dz(k)<a name='799'>
         enddo<a name='800'>
#IFDEF _3D<a name='801'>
        endif<a name='802'>
       enddo<a name='803'>
      enddo<a name='804'>
#ENDIF<a name='805'>
<a name='806'>
<font color=#447700>!------------------- Get Solar Radiation --------------------------------<a name='807'></font>
if(SolarRad.eq.1) then<a name='808'>
      if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/Read_Solar_bin.f.html#READ_SOLAR'>Read_Solar</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_SOLAR_3">(TC_8,Rad)<a name='809'>
      if(numprocs.gt.1) call MPI_BCAST(Rad,im*jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='810'>
else<a name='811'>
      call <A href='../../html_code/CGEM_2.0/getSolar.f.html#GETSOLAR'>getSolar</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETSOLAR_3">(lon, lat, iYr, iMon, iDay, iHr, iMin, iSec, Rad, my_imstart, my_imend) <a name='812'>
endif<a name='813'>
<a name='814'>
<font color=#447700>!-------------------------------------------------------------------------<a name='815'></font>
<font color=#447700>! Check if a new NetCDF file need to be created to chunkify output file<a name='816'></font>
<font color=#447700>! before starting GEM_EPA, which writes out extra variables<a name='817'></font>
<font color=#447700>!-------------------------------------------------------------------------<a name='818'></font>
<a name='819'>
if (  mod( istep, iout ) .eq. 0 ) then<a name='820'>
<a name='821'>
    istep_out = istep_out + 1<a name='822'>
<a name='823'>
#IFDEF _3D<a name='824'>
  <font color=#447700>!----- If file size limit is reached, start a new file--------------<a name='825'></font>
    IF ( MOD( istep_out, TIMESTEPS_PER_OUTPUT_FILE ) .EQ. 0 ) THEN<a name='826'>
      <font color=#447700>! Close existing output NetCDF file and create a new one:<a name='827'></font>
      CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#CLOSE_FILE'>CLOSE_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_FILE_6">()<a name='828'>
      WRITE ( NETCDF_OUTPUT_FILE_NAME, '(A, I6.6, A)' )&amp;<a name='829'>
            trim(BASE_NETCDF_OUTPUT_FILE_NAME), istep_out, '.nc'<a name='830'>
      IF ( myid .EQ. 0 ) THEN<a name='831'>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#CREATE_FILE'>CREATE_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CREATE_FILE_4">( trim(NETCDF_OUTPUT_FILE_NAME), &amp;<a name='832'>
                          itot, jtot, nsl, &amp;<a name='833'>
                          nstep, &amp;<a name='834'>
                          iYr0, &amp;<a name='835'>
                          YRS, MONS, DAYS, HRS, MINS, SECS, &amp;<a name='836'>
                          IYRE, IMONE, IDAYE, IHRE, IMINE, ISECE, &amp;<a name='837'>
                          DT_OUT, &amp;<a name='838'>
#IFDEF _3D<a name='839'>
                          LON, LAT, H, FM, &amp;<a name='840'>
#ELSE<a name='841'>
                          LON(icent), LAT(jcent), H(icent,jcent), FM(icent,jcent), &amp;<a name='842'>
#ENDIF<a name='843'>
                          ZL, ZZ, DZ )<a name='844'>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#CLOSE_FILE'>CLOSE_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_FILE_7">()<a name='845'>
      END IF<a name='846'>
<a name='847'>
      CALL MPI_BARRIER( MPI_COMM_WORLD, mpierr ) <font color=#447700>! Wait until file closed.<a name='848'></font>
<a name='849'>
      <font color=#447700>! Each process opens the new output NetCDF file for writing:<a name='850'></font>
      CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#OPEN_FILE'>OPEN_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_FILE_6">( trim(NETCDF_OUTPUT_FILE_NAME), istep_out )<a name='851'>
    END IF<a name='852'>
  <font color=#447700>!-------End starting new file-----------------------------------<a name='853'></font>
#ENDIF<a name='854'>
<a name='855'>
endif  <font color=#447700>!end of "if (mod(istep,iout).eq.0)"<a name='856'></font>
<a name='857'>
      <font color=#447700>!      if(myid.eq.0) write(6,*) istep,"Before GEM_EPA",Rad(4,4),RadBotOut_ij(5,4)<a name='858'></font>
<font color=#447700>!-------------- GEM - Biogeochemical Equations  ---------------------------<a name='859'></font>
      call <A href='../../html_code/CGEM_2.0/GEM_EPA.f.html#GEM_EPA'>GEM_EPA</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEM_EPA_2">( lat, lon, zl, TC_8, f, zz, Rad, T, S, dz, d, &amp;<a name='860'>
                    istep, my_imstart, my_imend, wsm, fm2, RadBotOut_ij, &amp;<a name='861'>
                    CBODW, print_ave, istep_wait, myid, nstep, &amp;<a name='862'>
                    istep_start, istep_end, BASE_NETCDF_OUTPUT_FILE_NAME, &amp;<a name='863'>
                    iout, istep_out, &amp;<a name='864'>
                    RESTART_FILE_NAME, RESTART_FILE_TIMESTEP )<a name='865'>
       RESTART_FILE_TIMESTEP = 0 <font color=#447700>! Don't restart again during this run.<a name='866'></font>
      <font color=#447700>!if(myid.eq.0) write(6,*) istep,"After GEM_EPA",Rad(4,4),RadBotOut_ij(5,4)<a name='867'></font>
<a name='868'>
<font color=#447700>!------------------------- Read Wind Data ------------------------<a name='869'></font>
      if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/Read_Wind_bin.f.html#READ_WIND'>Read_Wind</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_WIND_2">(TC_8,Wind)<a name='870'>
      if(numprocs.gt.1) call MPI_BCAST(Wind,im*jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='871'>
<a name='872'>
<font color=#447700>!-------- Surface and Bottom Fluxes ---------------------------------------<a name='873'></font>
      call <A href='../../html_code/CGEM_2.0/Flux.f.html#FLUX'>Flux</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUX_2">(f,T,S,d,RadBotOut_ij,CBODW,wsm,fm2,dz,Wind,TC_8,istep,my_imstart,my_imend,myid,numprocs)<a name='874'>
<a name='875'>
<font color=#447700>!------------ River Calculations -----------------------------------------<a name='876'></font>
#IFDEF _3D<a name='877'>
      call <A href='../../html_code/CGEM_2.0/Add_River_Nutrients_orig.f.html#ADD_RIVER_NUTRIENTS'>Add_River_Nutrients</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_RIVER_NUTRIENTS_2">(iYr, TC_8, irv, jrv, wtrv, myid, numprocs, f,&amp;<a name='878'>
     &amp; my_imstart, my_imend, d, dxdy, dz)<a name='879'>
#ENDIF <a name='880'>
<a name='881'>
<font color=#447700>!----- Boundary Conditions Based On Varying Salinity -----------------------<a name='882'></font>
#IFDEF _3D<a name='883'>
      call <A href='../../html_code/CGEM_2.0/Set_Salinity_BCs_Kurtz.f.html#SET_SALINITY_BCS'>Set_Salinity_BCs</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SALINITY_BCS_2">(f,S,d_sfc,T,lat,fm,wsm,my_imstart,my_imend)<a name='884'>
      if(Which_Outer_BC.eq.1.or.Which_Outer_BC.eq.2) call <A href='../../html_code/CGEM_2.0/Set_BC_Zero.f.html#SET_BC_ZERO'>Set_BC_Zero</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_BC_ZERO_2">(f,wsm,my_imstart,my_imend)<a name='885'>
      if(Which_Outer_BC.eq.5) call <A href='../../html_code/CGEM_2.0/Set_Lateral_Flow_Zero.f.html#SET_LATERAL_FLOW_ZERO'>Set_Lateral_Flow_Zero</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_LATERAL_FLOW_ZERO_2">(Ux,Vx,Wx,my_imstart,my_imend)<a name='886'>
#ENDIF<a name='887'>
<a name='888'>
<font color=#447700>! --- Before advection and VMixing, combine A's and Q's ------------------<a name='889'></font>
       do k = 1, nsl<a name='890'>
#IFDEF _3D <a name='891'>
       do j = 1, jm<a name='892'>
         myi = 2<a name='893'>
         do i = my_imstart,my_imend<a name='894'>
          if(fm(i,j).eq.1) then<a name='895'>
#ENDIF<a name='896'>
             f(myi,j,k,iQn(:)) = f(myi,j,k,iQn(:)) * f(myi,j,k,iA(:))<a name='897'>
             f(myi,j,k,iQp(:)) = f(myi,j,k,iQp(:)) * f(myi,j,k,iA(:))<a name='898'>
#IFDEF _3D<a name='899'>
          endif<a name='900'>
          myi = myi + 1<a name='901'>
         enddo<a name='902'>
        enddo<a name='903'>
#ENDIF<a name='904'>
       enddo<a name='905'>
<a name='906'>
<font color=#447700>!----- 3D advection ---------------------------------------------------------<a name='907'></font>
#IFNDEF _3D<a name='908'>
 Ux=0.<a name='909'>
 Vx=0.<a name='910'>
 Wx=0.<a name='911'>
#ENDIF<a name='912'>
      call  <A href='../../html_code/CGEM_2.0/Adv3D.f.html#ADV3D'>Adv3D</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADV3D_2"> (im, jm, nz, nf, f, Ux, Vx, Wx, Vol, Volf, dT, dxdy, &amp;<a name='913'>
     &amp;       ws, wsm, my_imstart, my_imend, my_im, myid, numprocs, fm2)<a name='914'>
<a name='915'>
<font color=#447700>!-------------- Vertical Diffusion -------------------------------------------<a name='916'></font>
#IFDEF _3D<a name='917'>
      Kh(:,:,1:nz) = khm(:,:,1:nz)*Kh(:,:,1:nz) <font color=#447700>!Multiply Kh by Kh_coeff for h&lt;30<a name='918'></font>
#ELSE<a name='919'>
      Kh(i,j,1:nz) = khm(i,j,1:nz)*Kh(i,j,1:nz) <font color=#447700>!Multiply Kh by Kh_coeff for h&lt;30<a name='920'></font>
#ENDIF<a name='921'>
<a name='922'>
      if(Which_VMix.ne.0) then<a name='923'>
       call <A href='../../html_code/CGEM_2.0/VMixing.f.html#VMIXING'>VMixing</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VMIXING_2"> (im, jm, nz, nf, f, Kh, dT, d, dz, dzz, my_imstart, my_imend, fm2) <a name='924'>
      endif<a name='925'>
<a name='926'>
<font color=#447700>! --- After advection and VMixing, return to Q's ------------------<a name='927'></font>
       do k = 1, nsl<a name='928'>
#IFDEF _3D<a name='929'>
        do j = 1, jm<a name='930'>
         myi = 2<a name='931'>
         do i = my_imstart,my_imend<a name='932'>
          if(fm(i,j).eq.1) then<a name='933'>
#ENDIF<a name='934'>
            f(myi,j,k,iQn(:)) = f(myi,j,k,iQn(:)) / f(myi,j,k,iA(:))<a name='935'>
            f(myi,j,k,iQp(:)) = f(myi,j,k,iQp(:)) / f(myi,j,k,iA(:))<a name='936'>
#IFDEF _3D<a name='937'>
          endif<a name='938'>
          myi = myi + 1<a name='939'>
         enddo<a name='940'>
        enddo<a name='941'>
#ENDIF<a name='942'>
       enddo<a name='943'>
<a name='944'>
<a name='945'>
<font color=#447700>!--- Max/Min Check was removed, checks are in GEM_EPA, add back here if necessary  --------------<a name='946'></font>
<a name='947'>
<a name='948'>
<font color=#447700>! --- Update Volume<a name='949'></font>
#IFDEF _3D<a name='950'>
        Vol = Volf<a name='951'>
#ELSE<a name='952'>
        Vol(i,j,:) = Volf(i,j,:)<a name='953'>
#ENDIF<a name='954'>
<a name='955'>
<font color=#447700>! -------------- BEGIN OUTPUT DATA -------------------------------------------<a name='956'></font>
<font color=#447700>! --- dump output when istep is a multiple of iout<a name='957'></font>
      if (  mod( istep, iout ) .eq. 0 ) then<a name='958'>
<a name='959'>
       if(myid.eq.0) write(6,*) "ISTEP=", istep<a name='960'>
<a name='961'>
       CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#WRITE_SUBSET_DATA'>WRITE_SUBSET_DATA</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_SUBSET_DATA_4">( my_imstart, my_im, 1, jtot, 1, nsl, &amp;<a name='962'>
                                istep_out, f( fstart : fend, jstart:jend, :, : ) )<a name='963'>
       CALL MPI_BARRIER( MPI_COMM_WORLD, mpierr ) <font color=#447700>! Wait until file is updated<a name='964'></font>
<a name='965'>
      endif  <font color=#447700>!end of "if (mod(istep,iout).eq.0)"<a name='966'></font>
<font color=#447700>!------------------------- END OUTPUT DATA -------------------------------------      <a name='967'></font>
<a name='968'>
<font color=#447700>!ENDIF PEANUT<a name='969'></font>
#ENDIF  <a name='970'>
<a name='971'>
     enddo   <a name='972'>
<font color=#447700>!-------------- END TIME LOOP -----------------------------------<a name='973'></font>
<a name='974'>
if(OUT_1D.eq.1) then<a name='975'>
         call <A href='../../html_code/CGEM_2.0/Output_Data_1D_close.f.html#OUTPUT_DATA_1D_CLOSE'>Output_Data_1D_close</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_DATA_1D_CLOSE_2"><a name='976'>
endif<a name='977'>
<a name='978'>
if(Calibration.eq.1) call <A href='../../html_code/CGEM_2.0/Output_Data_Calibration_close.f.html#OUTPUT_DATA_CALIBRATION_CLOSE'>Output_Data_Calibration_close</A><A href='../../html_code/CGEM_2.0/CGEM.findshear.f.html#CGEM.findshear.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_DATA_CALIBRATION_CLOSE_2"><a name='979'>
<a name='980'>
<font color=#447700>!PEANUT     CALL CLOSE_FILE() ! Each process closes the output NetCDF file.<a name='981'></font>
<a name='982'>
<a name='983'>
write(6,*) "up, vp, wp", uprimebar, vprimebar, wprimebar<a name='984'>
<a name='985'>
<font color=#447700>!if(myid.eq.0) then<a name='986'></font>
<font color=#447700>!      open(19,file="UVW.bin",status='unknown',form='unformatted')<a name='987'></font>
<font color=#447700>!      write(19) Ux_tot,Vx_tot,Wx_tot<a name='988'></font>
<font color=#447700>!      close(19)<a name='989'></font>
<font color=#447700>!      write(6,*) "Ux_tot",Ux_tot(icent,jcent,nz)<a name='990'></font>
<font color=#447700>!      write(6,*) "Vx_tot",Vx_tot(icent,jcent,nz)<a name='991'></font>
<font color=#447700>!      write(6,*) "Wx_tot",Wx_tot(icent,jcent,nz)<a name='992'></font>
<font color=#447700>!endif<a name='993'></font>
<a name='994'>
<font color=#447700>!--------------------------------------------------------------------	 <a name='995'></font>
if(myid.eq.0) then<a name='996'>
         WRITE(6, "(' ')") <a name='997'>
         WRITE(6, "('The present 3D run is complete.')") <a name='998'>
         WRITE(6, "(' ')") 	 <a name='999'>
         WRITE(6, "('Time-levels ')") 	 <a name='1000'>
	 WRITE(6, "('istep_start = ',I5 )") istep_start<a name='1001'>
     WRITE(6, "('istep_end = ',I5 )") istep_end<a name='1002'>
	 WRITE(6, "('have been set or calculated. ')")<a name='1003'>
         WRITE(6, "(' ')") <a name='1004'>
         WRITE(6, "('The output timestep interval is iout = ', I10)") iout<a name='1005'>
	 WRITE(6, "('computation timesteps of dT = ', I10 )") dT<a name='1006'>
	 WRITE(6, "('seconds each.' )")<a name='1007'>
         WRITE(6, "(' ')") <a name='1008'>
         WRITE(6, "('The run had a starting date-time of: ')") <a name='1009'>
         WRITE(6, "(' ')")	 <a name='1010'>
	 WRITE(6, "('iYrS  = ', I4.4, ' iMonS = ', I2.2 )") iYrS ,iMonS<a name='1011'>
	 WRITE(6, "('iDayS = ', I2.2, ' iHrS  = ', I2.2 )") iDayS,iHrS<a name='1012'>
	 WRITE(6, "('iMinS = ', I2.2, ' iSecS = ', I2   )") iMinS,iSecS	  <a name='1013'>
         WRITE(6, "(' ')")	 <a name='1014'>
         WRITE(6, "('and an ending date-time of: ')")<a name='1015'>
         WRITE(6, "(' ')")	  <a name='1016'>
	 WRITE(6, "('iYrE  = ', I4.4, ' iMonE = ', I2.2 )") iYrE ,iMonE<a name='1017'>
	 WRITE(6, "('iDayE = ', I2.2, ' iHrE  = ', I2.2 )") iDayE,iHrE<a name='1018'>
	 WRITE(6, "('iMinE = ', I2.2, ' iSecE = ', I2   )") iMinE,iSecE <a name='1019'>
	 <a name='1020'>
	 WRITE(6, "('******************************************')")<a name='1021'>
<a name='1022'>
endif<a name='1023'>
 <a name='1024'>
<font color=#447700>!----------------------------------------------------------------<a name='1025'></font>
<font color=#447700>! If we get here, there will be a normal exit from the program and<a name='1026'></font>
<font color=#447700>! exit code will be set to 0<a name='1027'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1028'></font>
<a name='1029'>
      mpitime2 = MPI_WTIME()<a name='1030'>
      if(myid.eq.0) write(6,*) "Code took",mpitime2-mpitime1,"seconds"<a name='1031'>
<a name='1032'>
      call MPI_FINALIZE(mpierr)<a name='1033'>
<a name='1034'>
      call EXIT(exit_code)<a name='1035'>
<a name='1036'>
<font color=#447700>!-----------------------------------      <a name='1037'></font>
      END PROGRAM CGEM<a name='1038'>
<font color=#447700>!-----------------------------------  <a name='1039'></font>
</pre></body></html>