<HTML> <BODY BGCOLOR=#eeeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!-------------------------------------------<a name='2'></font>
<font color=#447700>!PI: John C. Lehrter, Ph.D.<a name='3'></font>
<font color=#447700>!USEPA/NHEERL Gulf Ecology Division<a name='4'></font>
<font color=#447700>!1 Sabine Island Drive<a name='5'></font>
<font color=#447700>!Gulf Breeze, FL 32561-5299<a name='6'></font>
<font color=#447700>!(850) 934-9255<a name='7'></font>
<font color=#447700>!(850) 934-2401 -- fax<a name='8'></font>
<font color=#447700>!lehrter.john@epa.gov      <a name='9'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='10'></font>
<a name='11'>
<font color=#447700>!----------------------------------<a name='12'></font>
<A NAME='CGEM'><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM' TARGET='top_target'><IMG SRC="../../gif/bar_yellow.gif" border=0></A><a name='13'>
      <font color=#993300>PROGRAM  </font><font color=#cc0000>CGEM</font><a name='14'>
<font color=#447700>!----------------------------------<a name='15'></font>
<a name='16'>
<font color=#447700>!------------------------------------------------------------------------<a name='17'></font>
<font color=#447700>!     Written  by :: Lisa L. Lowe/EMVL, lowe.lisa@epa.gov <a name='18'></font>
<font color=#447700>!                    D.S.Ko/NRL  <a name='19'></font>
<font color=#447700>!                    Wei Tang/EMVL<a name='20'></font>
<font color=#447700>!                    Louis Olszyk/EMVL<a name='21'></font>
<font color=#447700>!                    Barry E. Herchenroder/EMVL <a name='22'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='23'></font>
<a name='24'>
<font color=#447700>!--------------------------------------------------------------<a name='25'></font>
<font color=#447700>!     Code to solve the Transport Equation:<a name='26'></font>
<font color=#447700>!<a name='27'></font>
<font color=#447700>!        dF/dt = dFu/dx+dFv/dy+dFw/dz     advection<a name='28'></font>
<font color=#447700>!                + d(Kh*dF/dz)/dz     vertical mixing<a name='29'></font>
<font color=#447700>!                + Q           source/sink incl river<a name='30'></font>
<font color=#447700>!                                         (in rate of change)<a name='31'></font>
<font color=#447700>!<a name='32'></font>
<font color=#447700>!     by apply one time step, upwind advection<a name='33'></font>
<font color=#447700>!     with vertical mixing<a name='34'></font>
<font color=#447700>!     Source/sink is provided by GEM_EPA<a name='35'></font>
<font color=#447700>!<a name='36'></font>
<font color=#447700>!     Work in sigma layers &lt;= max. sigma level<a name='37'></font>
<font color=#447700>!     Need e/t/s/Ux/Vx/Wx/Kh outputs from EPACOMv5<a name='38'></font>
<font color=#447700>!--------------------------------------------------------------<a name='39'></font>
<a name='40'>
     USE <A href='../../html_code/CGEM_2.0/Model_dim.f.html#MODEL_DIM'>Model_dim</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_DIM_10"><a name='41'>
     USE <A href='../../html_code/CGEM_2.0/INPUT_VARS.f.html#INPUT_VARS'>INPUT_VARS</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_VARS_8"> <font color=#447700>! For RESTART_FILE_TIMESTEP, etc.<a name='42'></font>
     USE <A href='../../html_code/CGEM_2.0/MPI_dim.f.html#MPI_DIM'>MPI_dim</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MPI_DIM_6"><a name='43'>
     USE <A href='../../html_code/CGEM_2.0/CGEM_vars.f.html#CGEM_VARS'>CGEM_vars</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CGEM_VARS_4"> <a name='44'>
     USE <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#OUTPUT_NETCDF'>OUTPUT_NETCDF</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_NETCDF_1"><a name='45'>
     USE <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#DATE_TIME'>DATE_TIME</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DATE_TIME_2"> <font color=#447700>! For TOTAL_SECONDS, DATE_TIMESTAMP.<a name='46'></font>
     USE <A href='../../html_code/CGEM_2.0/Which_Flux.f.html#WHICH_FLUX'>Which_Flux</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WHICH_FLUX_1"><a name='47'>
<a name='48'>
     IMPLICIT NONE<a name='49'>
<a name='50'>
     include "mpif.h"<a name='51'>
<a name='52'>
<font color=#447700>!---------------------<a name='53'></font>
<font color=#447700>! Declare Output parameters:    <a name='54'></font>
<font color=#447700>!---------------------<a name='55'></font>
     character(100) :: BASE_NETCDF_OUTPUT_FILE_NAME<a name='56'>
     integer, parameter :: TIMESTEPS_PER_OUTPUT_FILE = 1000 <font color=#447700>! Chunkify NetCDF output<a name='57'></font>
     character(256) NETCDF_OUTPUT_FILE_NAME<a name='58'>
     <font color=#447700>! If restarting, this is the name of the previous NetCDF output file.<a name='59'></font>
     character(256),parameter:: RESTART_FILE_NAME = './NETCDF/restart.nc'<a name='60'>
     INTEGER(8) LAST_TIMESTEP_SECONDS <font color=#447700>! last time variable written in restart NetCDF file<a name='61'></font>
     integer FILE_START <font color=#447700>! Start time step of a chunkified NetCDF file<a name='62'></font>
<a name='63'>
     integer, parameter :: exit_code = 0 <font color=#447700>! Status will be 0 when end<a name='64'></font>
                                         <font color=#447700>! of a successful run occurs.<a name='65'></font>
<a name='66'>
<font color=#447700>!-----------------<a name='67'></font>
           <a name='68'>
     real(kind=8), parameter :: SDay_8   = 86400.0_8       <font color=#447700>! secs in a day<a name='69'></font>
     integer  :: i, j, k, isp <font color=#447700>!loop variables<a name='70'></font>
     integer  :: iYr, iMon, iDay, iHr, iMin, iSec <font color=#447700>!Time variables<a name='71'></font>
     integer  :: YrS, MonS, DayS, HrS, MinS, SecS <font color=#447700>!Original start time for NetCDF global attibutes<a name='72'></font>
<a name='73'>
     integer  :: iout  <font color=#447700>!the output time-interval in timesteps<a name='74'></font>
     integer  :: istat <font color=#447700>!status variable      <a name='75'></font>
                             <a name='76'>
     integer  :: istep <font color=#447700>!current time step        <a name='77'></font>
     integer  :: istep_out <font color=#447700>!current output counter <a name='78'></font>
     integer  :: istep_start <font color=#447700>!time loop start<a name='79'></font>
     integer  :: istep_end <font color=#447700>!time loop end<a name='80'></font>
<a name='81'>
     integer  :: istep_wait <font color=#447700>!How many timesteps before 0600 hours (printing averages)<a name='82'></font>
     integer  :: print_ave  <font color=#447700>!How many timesteps in a day (printing averages)<a name='83'></font>
<a name='84'>
     integer  :: ns    <font color=#447700>!dummy read in variable<a name='85'></font>
     integer  :: nstep <font color=#447700>!total number of timesteps in a run <a name='86'></font>
     integer  :: nzr   <font color=#447700>!dummy read in variable <a name='87'></font>
<a name='88'>
     real         :: Hs <font color=#447700>!Reference water thickness          <a name='89'></font>
     integer(kind=8) :: TC_8 <font color=#447700>! Current time in seconds since Model_dim::iYr0.<a name='90'></font>
     integer(kind=8) :: START_SECONDS <font color=#447700>! Seconds from iYr0 to start of run.<a name='91'></font>
     integer(kind=8) :: END_SECONDS   <font color=#447700>! Seconds from iYr0 to end of run.<a name='92'></font>
     integer(kind=8) :: SECONDS_RAN   <font color=#447700>! Seconds since start of run<a name='93'></font>
<a name='94'>
     real, dimension(myimp2,jm)     ::   RadBotOut_ij  <font color=#447700>!Irradiance at bottom of cell<a name='95'></font>
     real, dimension(myimp2,jm,nsl) ::   CBODW         <font color=#447700>!Chem. Bio. O2 Demand in the water<a name='96'></font>
     real, dimension(im,jm,nsl) ::       d_sfc         <font color=#447700>!Distance from surface to center of cell<a name='97'></font>
<a name='98'>
     real     :: Vol(im,jm,nsl),Volf(im,jm,nsl),Volij <font color=#447700>!To calculate cell volume<a name='99'></font>
<a name='100'>
     real lat(jm),lon(im) <font color=#447700>!Latitude and longitude of each grid cell<a name='101'></font>
     real h(im,jm),d(im,jm) <font color=#447700>!h=water depth at cell center, d=h+elevation E <a name='102'></font>
     real E(im,jm,1),Kh(im,jm,kbm1) <font color=#447700>!E=surface elevation, Kh=vertical eddy diffusivity<a name='103'></font>
     real S(im,jm,kbm1),T(im,jm,kbm1)<font color=#447700>!S=Salinity in psu, T=temperature in Celsius<a name='104'></font>
     real Ux(im,jm,nsl),Vx(im,jm,nsl),Wx(im,jm,nsl) <font color=#447700>!Currents: velocity fluxes<a name='105'></font>
<a name='106'>
     real f(myimp2,jm,nsl,nf) <font color=#447700>!Array that holds value of 41 state variables<a name='107'></font>
     real dxdy(im,jm),dxy(jm) <font color=#447700>!dxdy=area for each grid, dxy=with across center of cell<a name='108'></font>
<a name='109'>
     real zl(kb),zz(kb) <font color=#447700>!zl=sigma at top of k, zz= sigma value at mid k<a name='110'></font>
     real dz(kb),dzz(kb) <font color=#447700>!dz=sigma thickness of layer k, dzz= zz(k+1)-zz(k)<a name='111'></font>
<a name='112'>
     real Rad(im,jm),Wind(im,jm) <font color=#447700>!Rad=Irradiance at top of sea surface, Wind= Wind velocity (m/s)<a name='113'></font>
<a name='114'>
     real wtrv(nsl,nr) <font color=#447700>!River flow weights<a name='115'></font>
     integer irv(nr),jrv(nr) <font color=#447700>!Holds i,j cell values for the nr rivers<a name='116'></font>
#IFNDEF _3D<a name='117'>
     integer lcent <font color=#447700>!For 1D, defines river cell (&gt;0)<a name='118'></font>
#ENDIF<a name='119'>
     integer fm(im,jm)  <font color=#447700>! land(0)/sea(1) mask<a name='120'></font>
     integer fm2(im,jm) <font color=#447700>! Modified land(0)/sea(1) mask (counts lateral BCs as land)<a name='121'></font>
     real wsm(im,jm)    <font color=#447700>! shelf(0)/open ocean(1) mask<a name='122'></font>
     real khm(im,jm,nz) <font color=#447700>! Multiplication factor mask for Kh<a name='123'></font>
     real tau(im,jm)    <font color=#447700>! Turbulence factor for J&amp;W flux<a name='124'></font>
<a name='125'>
<font color=#447700>!---------------------<a name='126'></font>
<font color=#447700>! Character variables <a name='127'></font>
<font color=#447700>!---------------------<a name='128'></font>
      character fn*80  <font color=#447700>!Generic file name holder <a name='129'></font>
      character*8 Which_hydro_c <font color=#447700>!command line input for hydro<a name='130'></font>
#ifdef DEBUG       <a name='131'>
      character*120 output_filename <font color=#447700>!Output file for debugging<a name='132'></font>
#endif<a name='133'>
      character*120 input_filename <font color=#447700>!Input file<a name='134'></font>
<font color=#447700>!------------------------------------------------ <a name='135'></font>
<a name='136'>
<font color=#447700>!---------------------<a name='137'></font>
<font color=#447700>! MPI variables<a name='138'></font>
<font color=#447700>!---------------------<a name='139'></font>
      integer myid,numprocs,mpierr,myi <font color=#447700>!processor id, # processors, error id, # columns on myid<a name='140'></font>
      integer my_imstart,my_imend <font color=#447700>!starting and ending i index for processor myid<a name='141'></font>
      integer my_im               <font color=#447700>!number of columns for processor myid<a name='142'></font>
      integer itot, istart, iend, fstart, fend  <font color=#447700>!for netCDF calls<a name='143'></font>
      integer jtot, jstart, jend        <font color=#447700>!for netCDF calls<a name='144'></font>
      real*8  mpitime1,mpitime2   <font color=#447700>!timing<a name='145'></font>
      <a name='146'>
<font color=#447700>!Command line<a name='147'></font>
      integer :: c_count<a name='148'>
<a name='149'>
<font color=#447700>!------------------------------------------------<a name='150'></font>
<font color=#447700>!Initialize MPI<a name='151'></font>
      call MPI_INIT(mpierr)<a name='152'>
      call MPI_COMM_RANK(MPI_COMM_WORLD, myid, mpierr)<a name='153'>
      call MPI_COMM_SIZE(MPI_COMM_WORLD, numprocs, mpierr)<a name='154'>
      mpitime1 = MPI_WTIME()<a name='155'>
<a name='156'>
#IFNDEF _3D<a name='157'>
      if(numprocs.ne.1) then<a name='158'>
           write(6,*) "1D, please run on 1 processor only"<a name='159'>
           call MPI_FINALIZE(mpierr)<a name='160'>
           stop<a name='161'>
      endif<a name='162'>
#ENDIF<a name='163'>
<a name='164'>
<font color=#447700>!Divide grid among processors<a name='165'></font>
      call <A href='../../html_code/CGEM_2.0/Decomp1D.f.html#DECOMP1D'>Decomp1D</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DECOMP1D_1">(im, numprocs, myid, my_imstart, my_imend)<a name='166'>
<a name='167'>
<font color=#447700>!Define Loop Bounds<a name='168'></font>
      my_im = my_imend - my_imstart + 1<a name='169'>
<a name='170'>
<font color=#447700>! --- Command Line Arguments for file names ---<a name='171'></font>
      if(myid.eq.0) then<a name='172'>
       c_count = command_argument_count()<a name='173'>
         BASE_NETCDF_OUTPUT_FILE_NAME = './NETCDF/output.'<a name='174'>
         input_filename = "GEM_InputFile"<a name='175'>
         Which_hydro_c = "Present"<a name='176'>
       if (c_count.eq.1) then<a name='177'>
         call get_command_argument(1,Which_hydro_c)<a name='178'>
       elseif (c_count.eq.2) then<a name='179'>
         call get_command_argument(1,Which_hydro_c)<a name='180'>
         call get_command_argument(2,BASE_NETCDF_OUTPUT_FILE_NAME)<a name='181'>
       elseif (c_count.eq.3) then<a name='182'>
         call get_command_argument(1,Which_hydro_c)<a name='183'>
         call get_command_argument(2,BASE_NETCDF_OUTPUT_FILE_NAME)<a name='184'>
         call get_command_argument(3,input_filename)<a name='185'>
       endif<a name='186'>
        if(Which_hydro_c.eq.'cc0') then       <font color=#447700>!Climate change cc0<a name='187'></font>
           Which_hydro = 1<a name='188'>
           write(6,*) "Hydro data is in hydro_input.dir.cc0"<a name='189'>
        elseif (Which_hydro_c.eq.'cc1') then  <font color=#447700>!Climate change cc1<a name='190'></font>
           Which_hydro = 2<a name='191'>
           write(6,*) "Hydro data is in hydro_input.dir.cc1"<a name='192'>
        elseif (Which_hydro_c.eq.'new') then  <font color=#447700>!Climate change cc1<a name='193'></font>
           Which_hydro = 3<a name='194'>
           write(6,*) "Hydro data is in hydro_input.dir.new"<a name='195'>
        else  <font color=#447700>!Default is "present" hydro<a name='196'></font>
           Which_hydro = 0<a name='197'>
           write(6,*) "Hydro data is in hydro_input.dir.EPA2_old"<a name='198'>
        endif<a name='199'>
       write(6,*) "Base Outputfile Name will be: ",trim(BASE_NETCDF_OUTPUT_FILE_NAME)<a name='200'>
       write(6,*) "Inputfile will be: ",trim(input_filename)<a name='201'>
      endif<a name='202'>
      if(numprocs.gt.1) call MPI_BCAST(BASE_NETCDF_OUTPUT_FILE_NAME,100,MPI_CHARACTER,0,MPI_COMM_WORLD,mpierr)<a name='203'>
      call MPI_BARRIER(MPI_COMM_WORLD,mpierr)<a name='204'>
<a name='205'>
<a name='206'>
<font color=#447700>! --- Inputs ----------------------------------------------------<a name='207'></font>
<font color=#447700>!----------------------<a name='208'></font>
<font color=#447700>! --- get grid location<a name='209'></font>
<font color=#447700>!----------------------<a name='210'></font>
   if (myid .eq. 0) then<a name='211'>
<font color=#447700>!----------------------------------------<a name='212'></font>
      fn = TRIM(HYDRODIR//'latlon.dat')<a name='213'>
      open (19,file=fn,status='old')<a name='214'>
      read (19,*) <a name='215'>
      read (19,*) lat<a name='216'>
      read (19,*) lon <a name='217'>
      close(19)<a name='218'>
<a name='219'>
<font color=#447700>!--------------------      <a name='220'></font>
<font color=#447700>! --- get model depth<a name='221'></font>
<font color=#447700>!--------------------<a name='222'></font>
<font color=#447700>!--------------------------------------<a name='223'></font>
      fn = TRIM(HYDRODIR//'TopoS.dat')            <a name='224'>
      open (19,file=fn,status='old')<a name='225'>
      read (19,*) <a name='226'>
      read (19,*) h      <font color=#447700>! This is the undisturbed water depth at <a name='227'></font>
      close(19)          <font color=#447700>!  the center of cells <a name='228'></font>
   endif                 <a name='229'>
   if(numprocs.gt.1) then<a name='230'>
      call MPI_BCAST(lat,jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='231'>
      call MPI_BCAST(lon,im,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='232'>
      call MPI_BCAST(h,im*jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='233'>
   endif<a name='234'>
<a name='235'>
<font color=#447700>!----------------------------------------------------------------------	 <a name='236'></font>
<font color=#447700>! --- create a land-sea mask (land=0;ocean=1)<a name='237'></font>
<font color=#447700>!----------------------------------------------------------------------	<a name='238'></font>
      do j = 1,jm<a name='239'>
      do i = 1,im <a name='240'>
          if (h(i,j).gt.1.) then  <font color=#447700>! Mask to determine if cell is land or ocean<a name='241'></font>
            fm(i,j) = 1  <font color=#447700>!ocean cell<a name='242'></font>
          else<a name='243'>
            fm(i,j) = 0  <font color=#447700>!land cell<a name='244'></font>
          endif<a name='245'>
        enddo<a name='246'>
      enddo<a name='247'>
<a name='248'>
      do j = 1, jm<a name='249'>
        do i = 1, im<a name='250'>
          if (h(i,j).le.100) then  <font color=#447700>! Mask to determine if cell is<a name='251'></font>
                                   <font color=#447700>! on the shelf or open ocean<a name='252'></font>
            wsm(i,j) = 0. <font color=#447700>!shelf<a name='253'></font>
          else<a name='254'>
            wsm(i,j) = 1. <font color=#447700>!open ocean<a name='255'></font>
          endif<a name='256'>
        enddo<a name='257'>
      enddo<a name='258'>
<a name='259'>
<font color=#447700>!Alternate Mask: Make lateral boundary cells "land" cells so they aren't modified/looped over in the code:<a name='260'></font>
      fm2(:,:) = fm(:,:)<a name='261'>
      fm2(1,:)  = 0<a name='262'>
      fm2(im,:) = 0<a name='263'>
      fm2(:,1)  = 0<a name='264'>
      fm2(:,jm) = 0<a name='265'>
<a name='266'>
<font color=#447700>! ---------------------------------------------------------------<a name='267'></font>
<font color=#447700>!     Read model parameters<a name='268'></font>
<font color=#447700>! ---------------------------------------------------------------<a name='269'></font>
      if (myid .eq. 0) call <A href='../../html_code/CGEM_2.0/rPointer.f.html#RPOINTER'>rPointer</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RPOINTER_1">(nko, no, io, jo, ko) <a name='270'>
      if(numprocs.gt.1) then<a name='271'>
       call MPI_BCAST(io,no,MPI_INTEGER,0,MPI_COMM_WORLD,mpierr)<a name='272'>
       call MPI_BCAST(jo,no,MPI_INTEGER,0,MPI_COMM_WORLD,mpierr)<a name='273'>
       call MPI_BCAST(ko,no,MPI_INTEGER,0,MPI_COMM_WORLD,mpierr)<a name='274'>
      endif<a name='275'>
<a name='276'>
<font color=#447700>!--------------------------------------<a name='277'></font>
<font color=#447700>! --- get model grid sizes<a name='278'></font>
<font color=#447700>!--------------------------------------<a name='279'></font>
      if(myid.eq.0) then<a name='280'>
       fn = TRIM(HYDRODIR//'dxdy.dat')<a name='281'>
       OPEN (19,FILE=fn,STATUS='OLD')<a name='282'>
       READ (19,*)<a name='283'>
       READ (19,*) dxy <font color=#447700>! Holds dx(j) values, j=1,im; j is row index. <a name='284'></font>
                       <font color=#447700>!  dx(j) is width of cell for row j across center <a name='285'></font>
		       <font color=#447700>!  of the cell. dy = 1890.3164 m. is S-N width of <a name='286'></font>
		       <font color=#447700>!  a cell across the center of the cell<a name='287'></font>
       CLOSE(19)      <a name='288'>
<a name='289'>
<font color=#447700>!---------------------------------------<a name='290'></font>
<font color=#447700>! --- get model vertical grid<a name='291'></font>
<font color=#447700>!---------------------------------------<a name='292'></font>
      fn = TRIM(HYDRODIR//'Depth.dat')<a name='293'>
      OPEN (19,FILE=fn,STATUS='OLD')<a name='294'>
      READ (19,*) nzr,ns,Hs         <font color=#447700>! Hs is a reference<a name='295'></font>
                                    <font color=#447700>!  depth used to calculate<a name='296'></font>
				    <font color=#447700>!  sigma values given depths<a name='297'></font>
				    <font color=#447700>!  of layer surfaces and <a name='298'></font>
				    <font color=#447700>!  centers.<a name='299'></font>
      READ (19,*) zl<a name='300'>
      READ (19,*) zz<a name='301'>
      READ (19,*) dz<a name='302'>
      CLOSE(19)<a name='303'>
     endif  <font color=#447700>!endif myid.eq.0<a name='304'></font>
     if(numprocs.gt.1) then<a name='305'>
      call MPI_BCAST(dxy,jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='306'>
      call MPI_BCAST(Hs,1,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='307'>
      call MPI_BCAST(zl,kb,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='308'>
      call MPI_BCAST(zz,kb,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='309'>
      call MPI_BCAST(dz,kb,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='310'>
     endif<a name='311'>
<a name='312'>
<font color=#447700>!---------------------------------------------------------------------<a name='313'></font>
<font color=#447700>!     ns : no. of sigma levels at center of sigma layers, i.e. the number<a name='314'></font>
<font color=#447700>!     of sigma layers- convert dz,zl,zz to sigma by dividing thru by the<a name='315'></font>
<font color=#447700>!     reference water thickness, Hs <a name='316'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='317'></font>
      do k = 1, nsl<a name='318'>
         dz(k) = dz(k)/Hs   <font color=#447700>! dz(k) on RHS is thickness (m) of layer k<a name='319'></font>
                            <font color=#447700>! On LHS, dz(k) is sigma thickness of layer k<a name='320'></font>
      enddo <a name='321'>
<a name='322'>
<font color=#447700>!------------------------------------------------------------- <a name='323'></font>
<font color=#447700>! In the next loop, we need zl(k=nsl+1) to calculate elevation<a name='324'></font>
<font color=#447700>! (i.e. depth) at the bottom of sigma layer k = nsl, i.e. the<a name='325'></font>
<font color=#447700>! top of layer k = nsl+1.<a name='326'></font>
<font color=#447700>!<a name='327'></font>
<font color=#447700>! In the next loop We also need zz(k=nsl+1) to calculate dzz(nsl)<a name='328'></font>
<font color=#447700>! in the following loop that calculates dzz array elements<a name='329'></font>
<font color=#447700>!-------------------------------------------------------------<a name='330'></font>
      do k = 1, nsl+1<a name='331'>
         zl(k) = zl(k)/Hs   <font color=#447700>! zl(k) on RHS is depth (m) at at top<a name='332'></font>
                            <font color=#447700>!  of layer k with zl(ns+1)=depth at sea<a name='333'></font>
                            <font color=#447700>!  bottom. On LHS, zl(k) is the sigma<a name='334'></font>
                            <font color=#447700>!  value associated with the top interface<a name='335'></font>
                            <font color=#447700>!  of layer k<a name='336'></font>
<a name='337'>
         zz(k) = zz(k)/Hs   <font color=#447700>! zz(k) on RHS is depth (m) at middle of<a name='338'></font>
                            <font color=#447700>!  layer k. on LHS, zz(k) is the sigma<a name='339'></font>
                            <font color=#447700>!  value associated with the middle of<a name='340'></font>
                            <font color=#447700>!  layer k.<a name='341'></font>
      enddo<a name='342'>
<a name='343'>
      do k = 1, nsl               <font color=#447700>! zz(k)   = sigma at middle of layer k<a name='344'></font>
         dzz(k) = zz(k+1)-zz(k)   <font color=#447700>! zz(k+1) = sigma at middle of layer k+1<a name='345'></font>
                                  <font color=#447700>! dzz(k)  = sigma difference between<a name='346'></font>
                                  <font color=#447700>!   middle of layer k+1 and middle of layer k<a name='347'></font>
      enddo<a name='348'>
<a name='349'>
<font color=#447700>!-----------------------------------------------------------------------<a name='350'></font>
      do j = 1, jm<a name='351'>
          do i=1,im<a name='352'>
            dxdy(i,j) = dxy(j)*dxy(j)     <font color=#447700>! Area for each grid = dx*dy<a name='353'></font>
            h(i,j) = amin1(h(i,j),Hs)     <font color=#447700>! Depth for sigma layers, maximum depth 100<a name='354'></font>
         enddo<a name='355'>
      enddo<a name='356'>
<a name='357'>
<font color=#447700>!---------------------------------------------------------------<a name='358'></font>
<font color=#447700>! Read Input Data, from input_filename <a name='359'></font>
<font color=#447700>!------------------------------------------------------------- <a name='360'></font>
      call <A href='../../html_code/CGEM_2.0/Read_InputFile.f.html#READ_INPUTFILE'>Read_InputFile</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_INPUTFILE_1">(input_filename,lat,lon,myid,numprocs)<a name='361'>
<a name='362'>
      <font color=#447700>! Save the original start time for defining NetCDF global attibutes,<a name='363'></font>
      <font color=#447700>! in case of crash restart, the values of i**S will be overwritten.<a name='364'></font>
       YrS = iYrS<a name='365'>
       MonS = iMonS<a name='366'>
       DayS = iDayS<a name='367'>
       HrS = iHrS<a name='368'>
       MinS = iMinS<a name='369'>
       SecS = iSecS<a name='370'>
<a name='371'>
       START_SECONDS = &amp;<a name='372'>
         <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#TOTAL_SECONDS'>TOTAL_SECONDS</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOTAL_SECONDS_2">( iYr0, iYrS, iMonS, iDayS, iHrS, iMinS, iSecS )<a name='373'>
<a name='374'>
      <font color=#447700>! Compute RESTART_FILE_TIMESTEP if restarting (regular or due to a crash):<a name='375'></font>
<a name='376'>
      LAST_TIMESTEP_SECONDS = 0<a name='377'>
      SECONDS_RAN = 0<a name='378'>
<a name='379'>
      IF ( InitializeHow .EQ. 1 .OR. InitializeHow .EQ. 2 ) THEN <font color=#447700>! Restarting:<a name='380'></font>
        RESTART_FILE_TIMESTEP =                                         &amp;<a name='381'>
          <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#LAST_NETCDF_TIMESTEP'>LAST_NETCDF_TIMESTEP</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LAST_NETCDF_TIMESTEP_1">( RESTART_FILE_NAME,                      &amp;<a name='382'>
                                iYrS, iMonS, iDayS, iHrS, iMinS, iSecS, &amp;<a name='383'>
                                iYrE, iMonE, iDayE, iHrE, iMinE, iSecE, &amp;<a name='384'>
                                dT_out, InitializeHow .EQ. 2,           &amp;<a name='385'>
                                LAST_TIMESTEP_SECONDS )<a name='386'>
<a name='387'>
        <font color=#447700>! Crash restart, new start time<a name='388'></font>
        IF ( InitializeHow .EQ. 2 ) THEN<a name='389'>
            SECONDS_RAN = LAST_TIMESTEP_SECONDS - START_SECONDS<a name='390'>
            CALL <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#DATE_TIMESTAMP'>DATE_TIMESTAMP</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DATE_TIMESTAMP_1">( iYr0, LAST_TIMESTEP_SECONDS, &amp;<a name='391'>
                                 iYrS, iMonS, iDayS, iHrS, iMinS, iSecS )<a name='392'>
        END IF<a name='393'>
      END IF<a name='394'>
<a name='395'>
      if(myid.eq.0.and.Out_1D.eq.1) write(6,*) "icent,jcent",icent,jcent <font color=#447700>!1D data written for this cell<a name='396'></font>
<a name='397'>
#IFNDEF _3D <a name='398'>
      if(fm(icent,jcent).eq.0) then<a name='399'>
        write(6,*) "You have chosen a land cell",icent,jcent<a name='400'>
        write(6,*) "Lat/Lon=",lat(jcent),lon(icent)<a name='401'>
        write(6,*) "Please change and run again."<a name='402'>
        call MPI_FINALIZE(mpierr)<a name='403'>
        stop<a name='404'>
      endif<a name='405'>
#ENDIF<a name='406'>
<a name='407'>
<a name='408'>
<font color=#447700>! Indices definitions for 1D vs 3D, and for netCDF<a name='409'></font>
#IFDEF _3D<a name='410'>
      fstart = 2<a name='411'>
      fend = my_im + 1<a name='412'>
      istart = my_imstart <a name='413'>
      iend = my_imend <a name='414'>
      jstart = 1<a name='415'>
      jend = jm<a name='416'>
      itot = im <a name='417'>
      jtot = jm<a name='418'>
#ELSE<a name='419'>
      i = icent<a name='420'>
      j = jcent<a name='421'>
      myi = icent + 1 <a name='422'>
      fstart = icent + 1<a name='423'>
      fend = icent + 1<a name='424'>
      istart = icent<a name='425'>
      jstart = jcent<a name='426'>
      iend = icent<a name='427'>
      jend = jcent<a name='428'>
      itot = 1<a name='429'>
      jtot = 1<a name='430'>
      my_im = 1<a name='431'>
#ENDIF<a name='432'>
<a name='433'>
<a name='434'>
#ifdef DEBUG<a name='435'>
<font color=#447700>!This will check if Read_InputFile is correctly reading and broadcasting<a name='436'></font>
      if(myid.eq.0) then<a name='437'>
       output_filename = "Debug_InputFile0"<a name='438'>
       call <A href='../../html_code/CGEM_2.0/Write_InputFile.f.html#WRITE_INPUTFILE'>Write_InputFile</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_INPUTFILE_1">(output_filename)<a name='439'>
      endif<a name='440'>
      if(myid.eq.1) then<a name='441'>
       output_filename = "Debug_InputFile1"<a name='442'>
       call <A href='../../html_code/CGEM_2.0/Write_InputFile.f.html#WRITE_INPUTFILE'>Write_InputFile</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_INPUTFILE_2">(output_filename)<a name='443'>
      endif<a name='444'>
      call MPI_BARRIER(MPI_COMM_WORLD,mpierr)<a name='445'>
      stop<a name='446'>
#endif<a name='447'>
<a name='448'>
<font color=#447700>! Make mask for VMixing Coefficients<a name='449'></font>
      call <A href='../../html_code/CGEM_2.0/Depth_Kh_Mask.f.html#DEPTH_KH_MASK'>Depth_Kh_Mask</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEPTH_KH_MASK_1">(fm,h,khm)<a name='450'>
<a name='451'>
<font color=#447700>! Define when and how often to print intermediate values <a name='452'></font>
      call <A href='../../html_code/CGEM_2.0/Ave_istep_Offset.f.html#AVE_ISTEP_OFFSET'>Ave_istep_offset</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AVE_ISTEP_OFFSET_1">(istep_wait,print_ave)<a name='453'>
<a name='454'>
<font color=#447700>!Set Sinking Rates for Qn/Qp:<a name='455'></font>
       ws(iQn1:iQn6) = ws(iA1:iA6)<a name='456'>
       ws(iQp1:iQp6) = ws(iA1:iA6)<a name='457'>
<a name='458'>
<font color=#447700>!--- END READ INPUT DATA --------------------------------------------<a name='459'></font>
<a name='460'>
<a name='461'>
<font color=#447700>! ------------------<a name='462'></font>
<font color=#447700>!     Initialization<a name='463'></font>
<font color=#447700>! ------------------<a name='464'></font>
 <a name='465'>
<font color=#447700>! --- sinking speed: converted from m/d downward positive to m/s negative<a name='466'></font>
      ws = -ws/SDay_8<a name='467'>
<a name='468'>
      <font color=#447700>! Compute starting time of run in seconds since Model_dim::iYr0:<a name='469'></font>
<a name='470'>
      TC_8 = <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#TOTAL_SECONDS'>TOTAL_SECONDS</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOTAL_SECONDS_3">( iYr0, iYrS, iMonS, iDayS, iHrS, iMinS, iSecS )<a name='471'>
<a name='472'>
<font color=#447700>! Initialize arrays<a name='473'></font>
     E = -9999.<a name='474'>
     Kh = -9999. <a name='475'>
     S = -9999. <a name='476'>
     T = -9999. <a name='477'>
     Ux = 0. <a name='478'>
     Vx = 0. <a name='479'>
     Wx = 0. <a name='480'>
<a name='481'>
<font color=#447700>! Read in initial values<a name='482'></font>
      call <A href='../../html_code/CGEM_2.0/get_Init_EVars.f.html#GET_INIT_EVARS'>get_Init_EVars</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_INIT_EVARS_1">(TC_8,E,d,h,S,T,Kh,fm,myid,numprocs) <a name='483'>
      call <A href='../../html_code/CGEM_2.0/get_Init_UVars.f.html#GET_INIT_UVARS'>get_Init_UVars</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_INIT_UVARS_1">(TC_8,Ux,Vx,Wx,myid,numprocs)<a name='484'>
<a name='485'>
<font color=#447700>!Redo mask in terms of Ko's variable S, some are undefined at h&lt;=100:<a name='486'></font>
#IFDEF _3D<a name='487'>
      do j = 1, jm<a name='488'>
        do i = 1, im<a name='489'>
#ENDIF<a name='490'>
          if (S(i,j,nsl).le.0) then    <font color=#447700>! Determine if cell is<a name='491'></font>
                                       <font color=#447700>! on the shelf or open ocean<a name='492'></font>
            wsm(i,j) = 0. <font color=#447700>!shelf<a name='493'></font>
          endif<a name='494'>
#IFDEF _3D<a name='495'>
        enddo<a name='496'>
      enddo<a name='497'>
#ENDIF<a name='498'>
<a name='499'>
<font color=#447700>!========================================Initialization of f==================  <a name='500'></font>
<font color=#447700>!Define depth for Initial Conditions <a name='501'></font>
      do k=1,nsl<a name='502'>
#IFDEF _3D<a name='503'>
       do j=1,jm<a name='504'>
        do i=1,im<a name='505'>
#ENDIF<a name='506'>
         d_sfc(i,j,k) = d(i,j)*zz(k) <font color=#447700>!Depth from Surface to center of cell <a name='507'></font>
#IFDEF _3D<a name='508'>
        enddo<a name='509'>
       enddo<a name='510'>
#ENDIF<a name='511'>
      enddo<a name='512'>
<a name='513'>
      IF ( RESTART_FILE_TIMESTEP .NE. 0 ) THEN <font color=#447700>! Re-initialize f from previous NetCDF file:<a name='514'></font>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#READ_DATA'>READ_DATA</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_DATA_1">( RESTART_FILE_NAME, my_imstart, my_im, 1, jtot, 1, nsl, &amp;<a name='515'>
                        RESTART_FILE_TIMESTEP, &amp;<a name='516'>
                        f( fstart : fend, jstart:jend, :, : ) )<a name='517'>
<a name='518'>
        IF ( InitializeHow .EQ. 3 ) THEN<a name='519'>
          <font color=#447700>! Overwrite selective variables with salinity regression equations:<a name='520'></font>
          CALL <A href='../../html_code/CGEM_2.0/Set_Initial_Conditions_Kurtz.f.html#SET_INITIAL_CONDITIONS'>Set_Initial_Conditions</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_INITIAL_CONDITIONS_1">(f,S,d_sfc,T,lat,fm,my_imstart,my_imend)<a name='521'>
        END IF<a name='522'>
<a name='523'>
      ELSE <font color=#447700>! Initialize f array using salinity and depth:<a name='524'></font>
        CALL <A href='../../html_code/CGEM_2.0/Set_Initial_Conditions_Kurtz.f.html#SET_INITIAL_CONDITIONS'>Set_Initial_Conditions</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_INITIAL_CONDITIONS_2">(f,S,d_sfc,T,lat,fm,my_imstart,my_imend)<a name='525'>
      END IF<a name='526'>
<a name='527'>
<a name='528'>
<font color=#447700>!Values on shelf will be erroneous, set to -9999 as 'land' marker:<a name='529'></font>
      do isp = 1, nf<a name='530'>
#IFDEF _3D<a name='531'>
       do j=1,jm<a name='532'>
          myi = 2<a name='533'>
        do i=my_imstart,my_imend<a name='534'>
#ENDIF<a name='535'>
          if(wsm(i,j).eq.0.) then <font color=#447700>!if shelf<a name='536'></font>
           f(myi,j,nsl,isp) = -9999 <a name='537'>
          endif<a name='538'>
#IFDEF _3D<a name='539'>
          myi = myi + 1<a name='540'>
        enddo<a name='541'>
       enddo<a name='542'>
#ENDIF<a name='543'>
      enddo<a name='544'>
<a name='545'>
<a name='546'>
<font color=#447700>!========End Initialization of f==============================================<a name='547'></font>
<a name='548'>
if(Calibration.eq.1) then<a name='549'>
      call <A href='../../html_code/CGEM_2.0/Output_Data_Calibration_open.f.html#OUTPUT_DATA_CALIBRATION_OPEN'>Output_Data_Calibration_open</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_DATA_CALIBRATION_OPEN_1"><a name='550'>
endif<a name='551'>
<a name='552'>
<font color=#447700>!--- Initialize solar radiation --------------------------------------<a name='553'></font>
<font color=#447700>!!!if(SolarRad.eq.1) then<a name='554'></font>
<font color=#447700>!!!        if(myid.eq.0) call Read_Solar(TC_8,Rad)<a name='555'></font>
<font color=#447700>!!!        if(numprocs.gt.1) call MPI_BCAST(Rad,im*jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='556'></font>
<font color=#447700>!!!else<a name='557'></font>
<font color=#447700>!!!      call getSolar(lon, lat, iYrS, iMonS, iDayS, iHrS, iMinS, iSecS, Rad, my_imstart, my_imend)<a name='558'></font>
<font color=#447700>!!!endif<a name='559'></font>
<a name='560'>
<font color=#447700>!----------------------------------------------------------------------      <a name='561'></font>
<font color=#447700>! Calculate the river related variables and arrays for the initial time.<a name='562'></font>
<font color=#447700>!----------------------------------------------------------------------  <a name='563'></font>
      if(myid.eq.0) call  <A href='../../html_code/CGEM_2.0/river_data_init.f.html#RIVER_DATA_INIT'>river_data_init</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RIVER_DATA_INIT_1">(irv, jrv, wtrv) <a name='564'>
      if(numprocs.gt.1) then<a name='565'>
       call MPI_BCAST(irv,nr,MPI_INTEGER,0,MPI_COMM_WORLD,mpierr)<a name='566'>
       call MPI_BCAST(jrv,nr,MPI_INTEGER,0,MPI_COMM_WORLD,mpierr)<a name='567'>
       call MPI_BCAST(wtrv,nsl*nr,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='568'>
      endif<a name='569'>
<a name='570'>
<a name='571'>
#IFNDEF _3D<a name='572'>
      call <A href='../../html_code/CGEM_2.0/Is_River_Cell.f.html#IS_RIVER_CELL'>Is_River_Cell</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="IS_RIVER_CELL_1">(irv,jrv,icent,jcent,lcent)<a name='573'>
      if(lcent.ge.1) then<a name='574'>
         write(6,*) "Cell",i,j,"is river cell number",lcent<a name='575'>
         write(6,*) "Lat/Lon=",lat(jcent),lon(icent)<a name='576'>
         write(6,*) "Do not use 1D for River Cells"<a name='577'>
         write(6,*) "Change i,j or long/lat coords"<a name='578'>
         call MPI_FINALIZE(mpierr)<a name='579'>
         stop<a name='580'>
      endif<a name='581'>
#ENDIF<a name='582'>
<a name='583'>
<font color=#447700>!---------------------------------------------------<a name='584'></font>
<font color=#447700>! Calc nstep , the total number of timesteps in a run	<a name='585'></font>
<font color=#447700>!---------------------------------------------------       <a name='586'></font>
<a name='587'>
      START_SECONDS = &amp;<a name='588'>
        <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#TOTAL_SECONDS'>TOTAL_SECONDS</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOTAL_SECONDS_4">( iYr0, iYrS, iMonS, iDayS, iHrS, iMinS, iSecS )<a name='589'>
<a name='590'>
      END_SECONDS = &amp;<a name='591'>
        <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#TOTAL_SECONDS'>TOTAL_SECONDS</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOTAL_SECONDS_5">( iYr0, iYrE, iMonE, iDayE, iHrE, iMinE, iSecE )<a name='592'>
<a name='593'>
      nstep = ( END_SECONDS - START_SECONDS ) / dT<a name='594'>
<a name='595'>
<font color=#447700>!----------------------------------------------------------------------    <a name='596'></font>
<font color=#447700>! Set  iout, the output time-interval in timesteps. <a name='597'></font>
<font color=#447700>! The total number of time-levels output to the NetCDF file is istep_out + 1,<a name='598'></font>
<font color=#447700>! including the output for the initial time in the output time-interval.<a name='599'></font>
<font color=#447700>!----------------------------------------------------------------------- <a name='600'></font>
      iout = dT_out/dT <a name='601'>
      istep = 0<a name='602'>
      istep_out = 0<a name='603'>
      istep_start = 1<a name='604'>
<a name='605'>
      IF ( InitializeHow .EQ. 2 ) THEN<a name='606'>
      <font color=#447700>! When crash restart, the time loop start and output start need to be changed.<a name='607'></font>
        istep_out = SECONDS_RAN / dT_out<a name='608'>
        istep_start = istep_out * iout + 1<a name='609'>
      END IF<a name='610'>
<a name='611'>
      istep_end = istep_start + nstep - 1<a name='612'>
<a name='613'>
<font color=#447700>!--- Volume for each grid (counted the free surface)<a name='614'></font>
#IFDEF _3D<a name='615'>
      Vol = -9999 <a name='616'>
      do j = 1,jm<a name='617'>
       do i = 1,im<a name='618'>
        if(fm(i,j).eq.1) then<a name='619'>
#ENDIF<a name='620'>
         Volij = d(i,j)*dxdy(i,j)<a name='621'>
          do k = 1, nsl<a name='622'>
           Vol(i,j,k) = Volij*dz(k)<a name='623'>
          enddo<a name='624'>
#IFDEF _3D<a name='625'>
        endif<a name='626'>
       enddo<a name='627'>
      enddo<a name='628'>
#ENDIF<a name='629'>
<a name='630'>
<font color=#447700>!-- First process creates the output NetCDF file with static data: --------<a name='631'></font>
<a name='632'>
      WRITE ( NETCDF_OUTPUT_FILE_NAME, '(A, I6.6, A)' )&amp;<a name='633'>
              trim(BASE_NETCDF_OUTPUT_FILE_NAME), istep_out, '.nc'<a name='634'>
<a name='635'>
      IF ( myid .EQ. 0 ) THEN<a name='636'>
<a name='637'>
        <font color=#447700>! Create a new NetCDF file in non-crash-restart cases only:<a name='638'></font>
        IF ( InitializeHow .NE. 2 ) THEN<a name='639'>
          CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#CREATE_FILE'>CREATE_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CREATE_FILE_1">( trim(NETCDF_OUTPUT_FILE_NAME), &amp;<a name='640'>
                            itot, jtot, nsl, &amp;<a name='641'>
                            nstep, &amp;<a name='642'>
                            iYr0, &amp;<a name='643'>
                            YRS, MONS, DAYS, HRS, MINS, SECS, &amp;<a name='644'>
                            IYRE, IMONE, IDAYE, IHRE, IMINE, ISECE, &amp;<a name='645'>
                            DT_OUT, &amp;<a name='646'>
#IFDEF _3D<a name='647'>
                            LON, LAT, H, FM, &amp;<a name='648'>
#ELSE<a name='649'>
                            LON(icent), LAT(jcent), H(icent,jcent), FM(icent,jcent), &amp;<a name='650'>
#ENDIF<a name='651'>
                            ZL, ZZ, DZ )<a name='652'>
          CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#CLOSE_FILE'>CLOSE_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_FILE_1">()<a name='653'>
        END IF<a name='654'>
      END IF<a name='655'>
      CALL MPI_BARRIER( MPI_COMM_WORLD, mpierr ) <font color=#447700>! Wait until file is created.<a name='656'></font>
<a name='657'>
<font color=#447700>! Each process opens the output file for writing:<a name='658'></font>
      IF ( InitializeHow .EQ. 2 ) THEN<a name='659'>
        <font color=#447700>! Chunked file starting timestep:<a name='660'></font>
        FILE_START = INT(istep_out/TIMESTEPS_PER_OUTPUT_FILE) * TIMESTEPS_PER_OUTPUT_FILE<a name='661'>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#OPEN_FILE'>OPEN_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_FILE_1">( trim(RESTART_FILE_NAME), FILE_START ) <font color=#447700>! Append to crashed file.<a name='662'></font>
      ELSE<a name='663'>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#OPEN_FILE'>OPEN_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_FILE_2">( trim(NETCDF_OUTPUT_FILE_NAME), 0 )<a name='664'>
      END IF<a name='665'>
<a name='666'>
      CALL MPI_BARRIER( MPI_COMM_WORLD, mpierr ) <font color=#447700>! Wait until file is opened<a name='667'></font>
<a name='668'>
<font color=#447700>!------- End open netCDF file ------------------------------------------------<a name='669'></font>
<a name='670'>
<font color=#447700>!!!      ! Write initial configuration in non-crash-restart cases only:<a name='671'></font>
<a name='672'>
      IF ( InitializeHow .NE. 2 ) THEN<a name='673'>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#WRITE_SUBSET_DATA'>WRITE_SUBSET_DATA</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_SUBSET_DATA_1">( my_imstart, my_im, 1, jtot, 1, nsl, 0, &amp;<a name='674'>
                                f( fstart : fend, jstart:jend, :, : ) )<a name='675'>
        CALL MPI_BARRIER( MPI_COMM_WORLD, mpierr ) <font color=#447700>! Wait until file is updated.<a name='676'></font>
<a name='677'>
<font color=#447700>!--- Initialize growth and irradiance variables for initial netCDF file<a name='678'></font>
        call <A href='../../html_code/CGEM_2.0/GEM_EPA_INIT.f.html#GEM_EPA_INIT'>GEM_EPA_INIT</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEM_EPA_INIT_1">(my_imstart, my_imend, fm, wsm, istep_out, &amp;<a name='679'>
          RESTART_FILE_NAME, RESTART_FILE_TIMESTEP )<a name='680'>
 <a name='681'>
      END IF<a name='682'>
<a name='683'>
<font color=#447700>!-----------------------<a name='684'></font>
<font color=#447700>! Initialization is done<a name='685'></font>
<font color=#447700>!-----------------------<a name='686'></font>
<a name='687'>
<font color=#447700>!---------------------------<a name='688'></font>
<font color=#447700>! Beginning of the time-loop<a name='689'></font>
<font color=#447700>!---------------------------<a name='690'></font>
<a name='691'>
      TC_8 = START_SECONDS - dT / 2 <font color=#447700>! Subtract half dT to 'center' of timestep.<a name='692'></font>
<a name='693'>
<font color=#447700>!-------------- START TIME LOOP -----------------------------------<a name='694'></font>
      do istep = istep_start, istep_end<a name='695'>
       TC_8 = TC_8 + dT<a name='696'>
<a name='697'>
<font color=#447700>!------------------------------------------------------------------<a name='698'></font>
<font color=#447700>! Calculate iYr, iMon, iDay, iHr, iMin, iSec which <a name='699'></font>
<font color=#447700>! corresponds to the model timestamp, since iYr0 + TC_8 seconds.<a name='700'></font>
<font color=#447700>!------------------------------------------------------------------<a name='701'></font>
<a name='702'>
       CALL <A href='../../html_code/CGEM_2.0/DATE_TIME.f.html#DATE_TIMESTAMP'>DATE_TIMESTAMP</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DATE_TIMESTAMP_2">( iYr0, TC_8, &amp;<a name='703'>
                            iYr, iMon, iDay, iHr, iMin, iSec )<a name='704'>
<a name='705'>
if(OUT_1D.eq.1) then<a name='706'>
      <font color=#447700>!Write out 1D ascii file for R<a name='707'></font>
      call <A href='../../html_code/CGEM_2.0/Output_Data_1D.f.html#OUTPUT_DATA_1D_TEXT'>Output_Data_1D_text</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_DATA_1D_TEXT_1">(f,my_imstart,my_imend,istep,icent,jcent)<a name='708'>
endif<a name='709'>
<a name='710'>
<a name='711'>
<font color=#447700>!------------------------------------------------------------------<a name='712'></font>
<font color=#447700>! Read E, T, S, Kh, Ux, Vx, and Wx for TC_8<a name='713'></font>
<font color=#447700>!------------------------------------------------------------------<a name='714'></font>
      if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/gEPAssh.f.html#GEPASSH'>gEPAssh</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEPASSH_1"> (TC_8, E, istat) <a name='715'>
      if(numprocs.gt.1) then<a name='716'>
       call MPI_BCAST(E,im*jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='717'>
      endif<a name='718'>
<a name='719'>
      if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/gEPA_Tinterp.f.html#GEPA_TINTERP'>gEPA_Tinterp</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEPA_TINTERP_1"> (TC_8, T,S,Kh, istat) <a name='720'>
      if(numprocs.gt.1) then<a name='721'>
       call MPI_BCAST(T,im*jm*kbm1,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='722'>
       call MPI_BCAST(S,im*jm*kbm1,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='723'>
       call MPI_BCAST(Kh,im*jm*kbm1,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='724'>
      endif<a name='725'>
<a name='726'>
#IFDEF _3D<a name='727'>
      if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/gEPAflx_Tinterp.f.html#GEPAFLX_TINTERP'>gEPAflx_Tinterp</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEPAFLX_TINTERP_1">(TC_8,Ux,Vx,Wx,istat)<a name='728'>
      if(numprocs.gt.1) then<a name='729'>
       call MPI_BCAST(Ux,im*jm*nsl,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='730'>
       call MPI_BCAST(Vx,im*jm*nsl,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='731'>
       call MPI_BCAST(Wx,im*jm*nsl,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='732'>
      endif<a name='733'>
#ENDIF<a name='734'>
<a name='735'>
<font color=#447700>!----------------------------------------------------------------- <a name='736'></font>
<font color=#447700>! --- total stillwater thickness d (m.)for all sigma layers including <a name='737'></font>
<font color=#447700>!     the free surface. <a name='738'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='739'></font>
#IFDEF _3D<a name='740'>
      do j = 1,jm<a name='741'>
       do i = 1,im<a name='742'>
#ENDIF<a name='743'>
          d(i,j) = h(i,j)+E(i,j,1)                <a name='744'>
#IFDEF _3D<a name='745'>
       enddo                                       <a name='746'>
      enddo                  <a name='747'>
#ENDIF<a name='748'>
<a name='749'>
<font color=#447700>!--- Total Volume for all sigma layers including the free surface<a name='750'></font>
#IFDEF _3D<a name='751'>
      Volf=-9999<a name='752'>
      do j = 1,jm<a name='753'>
       do i = 1,im<a name='754'>
        if(fm(i,j).eq.1) then<a name='755'>
#ENDIF<a name='756'>
         Volij = d(i,j)*dxdy(i,j)<a name='757'>
         do k = 1, nsl<a name='758'>
          Volf(i,j,k) = Volij*dz(k)<a name='759'>
         enddo<a name='760'>
#IFDEF _3D<a name='761'>
        endif<a name='762'>
       enddo<a name='763'>
      enddo<a name='764'>
#ENDIF<a name='765'>
<a name='766'>
<font color=#447700>!------------------- Get Solar Radiation --------------------------------<a name='767'></font>
if(SolarRad.eq.1) then<a name='768'>
      if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/Read_Solar_bin.f.html#READ_SOLAR'>Read_Solar</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_SOLAR_1">(TC_8,Rad)<a name='769'>
      if(numprocs.gt.1) call MPI_BCAST(Rad,im*jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='770'>
else<a name='771'>
      call <A href='../../html_code/CGEM_2.0/getSolar.f.html#GETSOLAR'>getSolar</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETSOLAR_1">(lon, lat, iYr, iMon, iDay, iHr, iMin, iSec, Rad, my_imstart, my_imend) <a name='772'>
endif<a name='773'>
<a name='774'>
<font color=#447700>!-------------------------------------------------------------------------<a name='775'></font>
<font color=#447700>! Check if a new NetCDF file need to be created to chunkify output file<a name='776'></font>
<font color=#447700>! before starting GEM_EPA, which writes out extra variables<a name='777'></font>
<font color=#447700>!-------------------------------------------------------------------------<a name='778'></font>
<a name='779'>
if (  mod( istep, iout ) .eq. 0 ) then<a name='780'>
<a name='781'>
    istep_out = istep_out + 1<a name='782'>
<a name='783'>
#IFDEF _3D<a name='784'>
  <font color=#447700>!----- If file size limit is reached, start a new file--------------<a name='785'></font>
    IF ( MOD( istep_out, TIMESTEPS_PER_OUTPUT_FILE ) .EQ. 0 ) THEN<a name='786'>
      <font color=#447700>! Close existing output NetCDF file and create a new one:<a name='787'></font>
      CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#CLOSE_FILE'>CLOSE_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_FILE_2">()<a name='788'>
      WRITE ( NETCDF_OUTPUT_FILE_NAME, '(A, I6.6, A)' )&amp;<a name='789'>
            trim(BASE_NETCDF_OUTPUT_FILE_NAME), istep_out, '.nc'<a name='790'>
      IF ( myid .EQ. 0 ) THEN<a name='791'>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#CREATE_FILE'>CREATE_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CREATE_FILE_2">( trim(NETCDF_OUTPUT_FILE_NAME), &amp;<a name='792'>
                          itot, jtot, nsl, &amp;<a name='793'>
                          nstep, &amp;<a name='794'>
                          iYr0, &amp;<a name='795'>
                          YRS, MONS, DAYS, HRS, MINS, SECS, &amp;<a name='796'>
                          IYRE, IMONE, IDAYE, IHRE, IMINE, ISECE, &amp;<a name='797'>
                          DT_OUT, &amp;<a name='798'>
#IFDEF _3D<a name='799'>
                          LON, LAT, H, FM, &amp;<a name='800'>
#ELSE<a name='801'>
                          LON(icent), LAT(jcent), H(icent,jcent), FM(icent,jcent), &amp;<a name='802'>
#ENDIF<a name='803'>
                          ZL, ZZ, DZ )<a name='804'>
        CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#CLOSE_FILE'>CLOSE_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_FILE_3">()<a name='805'>
      END IF<a name='806'>
<a name='807'>
      CALL MPI_BARRIER( MPI_COMM_WORLD, mpierr ) <font color=#447700>! Wait until file closed.<a name='808'></font>
<a name='809'>
      <font color=#447700>! Each process opens the new output NetCDF file for writing:<a name='810'></font>
      CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#OPEN_FILE'>OPEN_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_FILE_3">( trim(NETCDF_OUTPUT_FILE_NAME), istep_out )<a name='811'>
    END IF<a name='812'>
  <font color=#447700>!-------End starting new file-----------------------------------<a name='813'></font>
#ENDIF<a name='814'>
<a name='815'>
endif  <font color=#447700>!end of "if (mod(istep,iout).eq.0)"<a name='816'></font>
<a name='817'>
<font color=#447700>!-------------- GEM - Biogeochemical Equations  ---------------------------<a name='818'></font>
      call <A href='../../html_code/CGEM_2.0/GEM_EPA.f.html#GEM_EPA'>GEM_EPA</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEM_EPA_1">( lat, lon, zl, TC_8, f, zz, Rad, T, S, dz, d, &amp;<a name='819'>
                    istep, my_imstart, my_imend, wsm, fm2, RadBotOut_ij, &amp;<a name='820'>
                    CBODW, print_ave, istep_wait, myid, nstep, &amp;<a name='821'>
                    istep_start, istep_end, BASE_NETCDF_OUTPUT_FILE_NAME, &amp;<a name='822'>
                    iout, istep_out, &amp;<a name='823'>
                    RESTART_FILE_NAME, RESTART_FILE_TIMESTEP )<a name='824'>
       RESTART_FILE_TIMESTEP = 0 <font color=#447700>! Don't restart again during this run.<a name='825'></font>
<a name='826'>
<font color=#447700>!------------------------- Read Wind Data ------------------------<a name='827'></font>
      if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/Read_Wind_bin.f.html#READ_WIND'>Read_Wind</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_WIND_1">(TC_8,Wind)<a name='828'>
      if(numprocs.gt.1) call MPI_BCAST(Wind,im*jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='829'>
<font color=#447700>!---Read Daily Current Averages for Turbulence---------------------<a name='830'></font>
      if(Which_fluxes(iSOC).eq.3) then<a name='831'>
       if(myid.eq.0) call <A href='../../html_code/CGEM_2.0/GetShear.f.html#GETSHEAR'>GetShear</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETSHEAR_1">(TC_8,Ux,Vx,Wx,S,T,lat,dxdy,dxy,d,dz,tau)<a name='832'>
       if(numprocs.gt.1) call MPI_BCAST(tau,im*jm,MPI_REAL,0,MPI_COMM_WORLD,mpierr)<a name='833'>
      else <a name='834'>
       tau=0.<a name='835'>
      endif<a name='836'>
<font color=#447700>!-------- Surface and Bottom Fluxes ---------------------------------------<a name='837'></font>
      call <A href='../../html_code/CGEM_2.0/Flux.f.html#FLUX'>Flux</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUX_1">(f,T,S,d,RadBotOut_ij,CBODW,wsm,fm2,dz,Wind,tau,TC_8,istep,my_imstart,my_imend,myid,numprocs)<a name='838'>
<a name='839'>
<font color=#447700>!------------ River Calculations -----------------------------------------<a name='840'></font>
#IFDEF _3D<a name='841'>
      call <A href='../../html_code/CGEM_2.0/Add_River_Nutrients_orig.f.html#ADD_RIVER_NUTRIENTS'>Add_River_Nutrients</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_RIVER_NUTRIENTS_1">(iYr, TC_8, irv, jrv, wtrv, myid, numprocs, f,&amp;<a name='842'>
     &amp; my_imstart, my_imend, d, dxdy, dz)<a name='843'>
#ENDIF <a name='844'>
<a name='845'>
<font color=#447700>!----- Boundary Conditions Based On Varying Salinity -----------------------<a name='846'></font>
#IFDEF _3D<a name='847'>
      call <A href='../../html_code/CGEM_2.0/Set_Salinity_BCs_Kurtz.f.html#SET_SALINITY_BCS'>Set_Salinity_BCs</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SALINITY_BCS_1">(f,S,d_sfc,T,lat,fm,wsm,my_imstart,my_imend)<a name='848'>
      if(Which_Outer_BC.eq.3) call <A href='../../html_code/CGEM_2.0/Set_BC_small_gradient.f.html#SET_BC_SMALL_GRADIENT'>Set_BC_small_gradient</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_BC_SMALL_GRADIENT_1">(f,wsm,Vol,wt_l,wt_o,my_imstart,my_imend,my_im)<a name='849'>
      if(Which_Outer_BC.eq.1.or.Which_Outer_BC.eq.2) call <A href='../../html_code/CGEM_2.0/Set_BC_Zero.f.html#SET_BC_ZERO'>Set_BC_Zero</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_BC_ZERO_1">(f,wsm,my_imstart,my_imend)<a name='850'>
      if(Which_Outer_BC.eq.5) call <A href='../../html_code/CGEM_2.0/Set_Lateral_Flow_Zero.f.html#SET_LATERAL_FLOW_ZERO'>Set_Lateral_Flow_Zero</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_LATERAL_FLOW_ZERO_1">(Ux,Vx,Wx,my_imstart,my_imend)<a name='851'>
#ENDIF<a name='852'>
<a name='853'>
<font color=#447700>! --- Before advection and VMixing, combine A's and Q's ------------------<a name='854'></font>
       do k = 1, nsl<a name='855'>
#IFDEF _3D <a name='856'>
       do j = 1, jm<a name='857'>
         myi = 2<a name='858'>
         do i = my_imstart,my_imend<a name='859'>
          if(fm(i,j).eq.1) then<a name='860'>
#ENDIF<a name='861'>
             f(myi,j,k,iQn(:)) = f(myi,j,k,iQn(:)) * f(myi,j,k,iA(:))<a name='862'>
             f(myi,j,k,iQp(:)) = f(myi,j,k,iQp(:)) * f(myi,j,k,iA(:))<a name='863'>
#IFDEF _3D<a name='864'>
          endif<a name='865'>
          myi = myi + 1<a name='866'>
         enddo<a name='867'>
        enddo<a name='868'>
#ENDIF<a name='869'>
       enddo<a name='870'>
<a name='871'>
<font color=#447700>!----- 3D advection ---------------------------------------------------------<a name='872'></font>
#IFNDEF _3D<a name='873'>
 Ux=0.<a name='874'>
 Vx=0.<a name='875'>
 Wx=0.<a name='876'>
#ENDIF<a name='877'>
      call  <A href='../../html_code/CGEM_2.0/Adv3D.f.html#ADV3D'>Adv3D</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADV3D_1"> (im, jm, nz, nf, f, Ux, Vx, Wx, Vol, Volf, dT, dxdy, &amp;<a name='878'>
     &amp;       ws, wsm, my_imstart, my_imend, my_im, myid, numprocs, fm2)<a name='879'>
<a name='880'>
<font color=#447700>!-------------- Vertical Diffusion -------------------------------------------<a name='881'></font>
#IFDEF _3D<a name='882'>
      Kh(:,:,1:nz) = khm(:,:,1:nz)*Kh(:,:,1:nz) <font color=#447700>!Multiply Kh by Kh_coeff for h&lt;30<a name='883'></font>
#ELSE<a name='884'>
      Kh(i,j,1:nz) = khm(i,j,1:nz)*Kh(i,j,1:nz) <font color=#447700>!Multiply Kh by Kh_coeff for h&lt;30<a name='885'></font>
#ENDIF<a name='886'>
<a name='887'>
      if(Which_VMix.ne.0) then<a name='888'>
       call <A href='../../html_code/CGEM_2.0/VMixing.f.html#VMIXING'>VMixing</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VMIXING_1"> (im, jm, nz, nf, f, Kh, dT, d, dz, dzz, my_imstart, my_imend, fm2) <a name='889'>
      endif<a name='890'>
<a name='891'>
<font color=#447700>! --- After advection and VMixing, return to Q's ------------------<a name='892'></font>
       do k = 1, nsl<a name='893'>
#IFDEF _3D<a name='894'>
        do j = 1, jm<a name='895'>
         myi = 2<a name='896'>
         do i = my_imstart,my_imend<a name='897'>
          if(fm(i,j).eq.1) then<a name='898'>
#ENDIF<a name='899'>
            f(myi,j,k,iQn(:)) = f(myi,j,k,iQn(:)) / f(myi,j,k,iA(:))<a name='900'>
            f(myi,j,k,iQp(:)) = f(myi,j,k,iQp(:)) / f(myi,j,k,iA(:))<a name='901'>
#IFDEF _3D<a name='902'>
          endif<a name='903'>
          myi = myi + 1<a name='904'>
         enddo<a name='905'>
        enddo<a name='906'>
#ENDIF<a name='907'>
       enddo<a name='908'>
<a name='909'>
<a name='910'>
<font color=#447700>!--- Max/Min Check was removed, checks are in GEM_EPA, add back here if necessary  --------------<a name='911'></font>
<a name='912'>
<a name='913'>
<font color=#447700>! --- Update Volume<a name='914'></font>
#IFDEF _3D<a name='915'>
        Vol = Volf<a name='916'>
#ELSE<a name='917'>
        Vol(i,j,:) = Volf(i,j,:)<a name='918'>
#ENDIF<a name='919'>
<a name='920'>
<font color=#447700>! -------------- BEGIN OUTPUT DATA -------------------------------------------<a name='921'></font>
<font color=#447700>! --- dump output when istep is a multiple of iout<a name='922'></font>
      if (  mod( istep, iout ) .eq. 0 ) then<a name='923'>
<a name='924'>
       if(myid.eq.0) write(6,*) "ISTEP=", istep<a name='925'>
<a name='926'>
       CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#WRITE_SUBSET_DATA'>WRITE_SUBSET_DATA</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_SUBSET_DATA_2">( my_imstart, my_im, 1, jtot, 1, nsl, &amp;<a name='927'>
                                istep_out, f( fstart : fend, jstart:jend, :, : ) )<a name='928'>
       CALL MPI_BARRIER( MPI_COMM_WORLD, mpierr ) <font color=#447700>! Wait until file is updated<a name='929'></font>
<a name='930'>
      endif  <font color=#447700>!end of "if (mod(istep,iout).eq.0)"<a name='931'></font>
<font color=#447700>!------------------------- END OUTPUT DATA -------------------------------------      <a name='932'></font>
<a name='933'>
     enddo   <a name='934'>
<font color=#447700>!-------------- END TIME LOOP -----------------------------------<a name='935'></font>
<a name='936'>
if(OUT_1D.eq.1) then<a name='937'>
         call <A href='../../html_code/CGEM_2.0/Output_Data_1D_close.f.html#OUTPUT_DATA_1D_CLOSE'>Output_Data_1D_close</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_DATA_1D_CLOSE_1"><a name='938'>
endif<a name='939'>
<a name='940'>
if(Calibration.eq.1) call <A href='../../html_code/CGEM_2.0/Output_Data_Calibration_close.f.html#OUTPUT_DATA_CALIBRATION_CLOSE'>Output_Data_Calibration_close</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_DATA_CALIBRATION_CLOSE_1"><a name='941'>
<a name='942'>
     CALL <A href='../../html_code/CGEM_2.0/OUTPUT_NETCDF.f.html#CLOSE_FILE'>CLOSE_FILE</A><A href='../../html_code/CGEM_2.0/CGEM.f.html#CGEM.f' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_FILE_4">() <font color=#447700>! Each process closes the output NetCDF file.<a name='943'></font>
<a name='944'>
<font color=#447700>!--------------------------------------------------------------------	 <a name='945'></font>
if(myid.eq.0) then<a name='946'>
         WRITE(6, "(' ')") <a name='947'>
         WRITE(6, "('The present 3D run is complete.')") <a name='948'>
         WRITE(6, "(' ')") 	 <a name='949'>
         WRITE(6, "('Time-levels ')") 	 <a name='950'>
	 WRITE(6, "('istep_start = ',I5 )") istep_start<a name='951'>
     WRITE(6, "('istep_end = ',I5 )") istep_end<a name='952'>
	 WRITE(6, "('have been set or calculated. ')")<a name='953'>
         WRITE(6, "(' ')") <a name='954'>
         WRITE(6, "('The output timestep interval is iout = ', I10)") iout<a name='955'>
	 WRITE(6, "('computation timesteps of dT = ', I10 )") dT<a name='956'>
	 WRITE(6, "('seconds each.' )")<a name='957'>
         WRITE(6, "(' ')") <a name='958'>
         WRITE(6, "('The run had a starting date-time of: ')") <a name='959'>
         WRITE(6, "(' ')")	 <a name='960'>
	 WRITE(6, "('iYrS  = ', I4.4, ' iMonS = ', I2.2 )") iYrS ,iMonS<a name='961'>
	 WRITE(6, "('iDayS = ', I2.2, ' iHrS  = ', I2.2 )") iDayS,iHrS<a name='962'>
	 WRITE(6, "('iMinS = ', I2.2, ' iSecS = ', I2   )") iMinS,iSecS	  <a name='963'>
         WRITE(6, "(' ')")	 <a name='964'>
         WRITE(6, "('and an ending date-time of: ')")<a name='965'>
         WRITE(6, "(' ')")	  <a name='966'>
	 WRITE(6, "('iYrE  = ', I4.4, ' iMonE = ', I2.2 )") iYrE ,iMonE<a name='967'>
	 WRITE(6, "('iDayE = ', I2.2, ' iHrE  = ', I2.2 )") iDayE,iHrE<a name='968'>
	 WRITE(6, "('iMinE = ', I2.2, ' iSecE = ', I2   )") iMinE,iSecE <a name='969'>
	 <a name='970'>
	 WRITE(6, "('******************************************')")<a name='971'>
<a name='972'>
endif<a name='973'>
 <a name='974'>
<font color=#447700>!----------------------------------------------------------------<a name='975'></font>
<font color=#447700>! If we get here, there will be a normal exit from the program and<a name='976'></font>
<font color=#447700>! exit code will be set to 0<a name='977'></font>
<font color=#447700>!----------------------------------------------------------------<a name='978'></font>
<a name='979'>
      mpitime2 = MPI_WTIME()<a name='980'>
      if(myid.eq.0) write(6,*) "Code took",mpitime2-mpitime1,"seconds"<a name='981'>
<a name='982'>
      call MPI_FINALIZE(mpierr)<a name='983'>
<a name='984'>
      call EXIT(exit_code)<a name='985'>
<a name='986'>
<font color=#447700>!-----------------------------------      <a name='987'></font>
      END PROGRAM CGEM<a name='988'>
<font color=#447700>!-----------------------------------  <a name='989'></font>
</pre></body></html>